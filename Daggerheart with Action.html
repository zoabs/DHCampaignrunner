<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daggerheart Campaign Manager</title>
  <style>
    :root {
      --bg-canvas: #0b1120;
      --bg-panel: #111827;
      --bg-surface: #1f2937;
      --bg-surface-alt: #374151;
      --border-soft: rgba(148, 163, 184, 0.12);
      --border-strong: rgba(59, 130, 246, 0.25);
      --shadow-soft: 0 20px 45px rgba(15, 23, 42, 0.45);
      --text-primary: #f3f4f6;
      --text-muted: #9ca3af;
      --accent-red: #dc2626;
      --accent-gold: #fbbf24;
      --accent-blue: #3b82f6;
      --radius-lg: 0.75rem;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.12), transparent 45%),
                  radial-gradient(circle at bottom right, rgba(248, 113, 113, 0.1), transparent 40%),
                  var(--bg-canvas);
      color: var(--text-primary);
      font-family: system-ui, -apple-system, sans-serif;
      padding: 1.5rem;
      min-height: 100vh;
    }
    .container { max-width: 1280px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    h1 { color: #dc2626; font-size: 2.25rem; }
    .btn-group { display: flex; gap: 0.5rem; }
    button, .btn-label { padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; cursor: pointer; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s; }
    .btn-primary { background: #dc2626; color: white; }
    .btn-primary:hover { background: #b91c1c; }
    .btn-green { background: #16a34a; color: white; }
    .btn-green:hover { background: #15803d; }
    .btn-blue { background: #2563eb; color: white; }
    .btn-blue:hover { background: #1d4ed8; }
    .btn-purple { background: #9333ea; color: white; }
    .btn-purple:hover { background: #7e22ce; }
    .btn-gray { background: #4b5563; color: white; }
    .btn-gray:hover { background: #374151; }
    .btn-yellow { background: #ca8a04; color: white; }
    .btn-yellow:hover { background: #a16207; }
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; overflow-x: auto; }
    .tab { padding: 0.75rem 1.5rem; border-radius: 0.375rem 0.375rem 0 0; border: none; cursor: pointer; background: #1f2937; color: #9ca3af; white-space: nowrap; }
    .tab.active { background: #dc2626; color: white; }
    .tab:hover:not(.active) { background: #374151; }
    .tab-session { background: #0f172a; border: 2px solid #1e40af; font-weight: bold; }
    .tab-session.active { background: #1e40af; color: #fbbf24; }
    .tab-session:hover:not(.active) { background: #1e293b; }
    .content { background: var(--bg-panel); border-radius: var(--radius-lg); padding: 2rem; box-shadow: 0 15px 45px rgba(15, 23, 42, 0.35); }
    .card { background: var(--bg-surface-alt); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .card-title { font-weight: bold; font-size: 1.125rem; }
    .card-content { color: #d1d5db; }
    .search-box { position: relative; flex: 1; max-width: 300px; }
    .search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; }
    .search-box input { width: 100%; padding: 0.5rem 0.5rem 0.5rem 2.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; }
    .filters { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
    .checkbox-label input[type="checkbox"] { width: 1rem; height: 1rem; cursor: pointer; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .status-alive { background: #16a34a; color: white; }
    .status-dead { background: #dc2626; color: white; }
    .status-unknown { background: #6b7280; color: white; }
    .status-met { background: #3b82f6; color: white; }
    .status-unmet { background: #9ca3af; color: white; }
    .star { color: #fbbf24; cursor: pointer; font-size: 1.25rem; }
    .star.inactive { color: #4b5563; }
    .delete-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; color: #f87171; background: transparent; }
    .delete-btn:hover { color: #dc2626; }
    .loot-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem; }
    .loot-tier-card { background: #374151; padding: 0.75rem; border-radius: 0.375rem; }
    .loot-tier-title { font-weight: bold; margin-bottom: 0.5rem; font-size: 0.875rem; }
    .loot-buttons { display: flex; flex-direction: column; gap: 0.5rem; }
    .hidden { display: none; }
    input[type="file"] { display: none; }
    .empty-state { color: #6b7280; font-size: 0.875rem; }
    .generation-card { background: #374151; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
    svg { width: 1.125rem; height: 1.125rem; }
    
    /* Session View */
    .session-container {
      display: grid;
      gap: 1.2rem;
      max-width: 1400px;
      margin: 0 auto;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      grid-template-areas:
        "fear countdown"
        "spotlight combat";
    }

    .session-section {
      background: linear-gradient(150deg, rgba(31, 41, 55, 0.95), rgba(17, 24, 39, 0.92));
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      position: relative;
      overflow: hidden;
    }

    .session-section::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.12), transparent 55%);
      opacity: 0.9;
    }

    .session-section > * {
      position: relative;
      z-index: 1;
    }

    .session-section.fear-tracker { grid-area: fear; }
    .session-section.countdown-section { grid-area: countdown; }
    .session-section.spotlight-section { grid-area: spotlight; }
    .session-section.combat-zones-section { grid-area: combat; }

    .session-section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.7rem;
    }

    .session-heading-group { display: flex; flex-direction: column; gap: 0.35rem; }

    .session-subtitle {
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .session-section-title {
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }

    .session-section-title svg { width: 1.25rem; height: 1.25rem; color: var(--accent-gold); }

    .session-metric {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-weight: 700;
      color: var(--accent-gold);
      font-size: 1.1rem;
      line-height: 1.1;
    }

    .session-metric span:last-child { font-size: 0.75rem; letter-spacing: 0.18em; color: var(--text-muted); text-transform: uppercase; }

    .session-toolbar { display: flex; gap: 0.5rem; flex-wrap: wrap; }

    .session-toolbar select,
    .session-toolbar input[type="text"] {
      padding: 0.45rem 0.65rem;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 0.5rem;
      color: var(--text-primary);
      min-width: 150px;
    }

    .session-divider {
      height: 1px;
      width: 100%;
      background: linear-gradient(90deg, rgba(148, 163, 184, 0), rgba(148, 163, 184, 0.35), rgba(148, 163, 184, 0));
    }

    .session-subcard {
      background: rgba(15, 23, 42, 0.65);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.16);
      padding: 0.8rem 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .session-subcard h3 { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
    @media (max-width: 1024px) {
      .session-container {
        grid-template-columns: 1fr;
        grid-template-areas:
          "fear"
          "countdown"
          "spotlight"
          "combat";
      }
    }
    .fear-tokens { display: flex; justify-content: flex-start; gap: 0.3rem; margin: 0.55rem 0; flex-wrap: wrap; }
    .fear-token { width: 24px; height: 24px; background: linear-gradient(135deg, #dc2626, #991b1b); border-radius: 50%; box-shadow: 0 3px 5px rgba(0,0,0,0.3), inset 0 2px 3px rgba(255,255,255,0.2); transition: all 0.4s ease; position: relative; }
    .fear-token.empty { background: #374151; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
    .fear-token.spending { animation: spendFear 0.6s ease; }
    .fear-token.gaining { animation: gainFear 0.5s ease; }
    @keyframes spendFear { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.8; background: #fbbf24; } 100% { transform: scale(0.8); opacity: 1; } }
    @keyframes gainFear { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.15); } 100% { transform: scale(1); opacity: 1; } }
    .fear-controls { display: flex; gap: 0.45rem; justify-content: flex-start; margin-top: 0.55rem; flex-wrap: wrap; }
    .fear-spend-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(220, 38, 38, 0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; animation: flashFear 1.2s ease-out; pointer-events: none; }
    .fear-spend-text { font-size: 5rem; font-weight: bold; color: white; text-shadow: 0 0 30px rgba(0,0,0,0.8); animation: fearTextPulse 1.2s ease-out; }
    @keyframes flashFear { 0% { opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
    @keyframes fearTextPulse { 0% { transform: scale(0.5); opacity: 0; } 30% { transform: scale(1.2); opacity: 1; } 70% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.8); opacity: 0; } }
    
    .countdown-item {
      background: rgba(15, 23, 42, 0.7);
      padding: 0.8rem 0.9rem;
      border-radius: var(--radius-lg);
      margin-bottom: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.25);
    }
    .countdown-item.at-zero { border: 2px solid #fbbf24; }
    .countdown-display { display: flex; justify-content: flex-start; gap: 0.35rem; margin: 0.7rem 0; flex-wrap: wrap; }
    .countdown-pip { width: 24px; height: 24px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 50%; box-shadow: 0 2px 3px rgba(0,0,0,0.3); transition: all 0.3s ease; }
    .countdown-pip.empty { background: #1f2937; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5); }
    .countdown-pip.decreasing { animation: decreaseCountdown 0.4s ease; }
    .countdown-pip.increasing { animation: increaseCountdown 0.4s ease; }
    @keyframes decreaseCountdown { 0% { transform: scale(1); } 50% { transform: scale(0.7); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes increaseCountdown { 0% { transform: scale(0.8); opacity: 0; } 60% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
    .countdown-controls { display: flex; gap: 0.5rem; align-items: center; justify-content: flex-start; margin-top: 0.7rem; flex-wrap: wrap; }
    .add-countdown-form {
      background: rgba(15, 23, 42, 0.65);
      padding: 0.75rem;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.18);
      display: flex;
      gap: 0.6rem;
      align-items: end;
      flex-wrap: wrap;
      margin-bottom: 0.9rem;
    }
    .form-field { display: flex; flex-direction: column; gap: 0.35rem; }
    .form-field label { font-size: 0.8rem; color: #9ca3af; }
    .form-field input,
    .form-field select {
      padding: 0.45rem 0.65rem;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 0.5rem;
      color: var(--text-primary);
    }
    
    .spotlight-controls { display: flex; gap: 0.5rem; margin-bottom: 0; width: 100%; }
    .spotlight-controls select { flex: 1; }
    .spotlight-grid { display: grid; gap: 0.7rem; }
    .spotlight-player {
      background: rgba(15, 23, 42, 0.7);
      padding: 0.8rem 1rem;
      border-radius: var(--radius-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
    }
    .spotlight-info { flex: 1; }
    .spotlight-name { font-weight: bold; font-size: 0.95rem; margin-bottom: 0.35rem; }
    .spotlight-pips { display: flex; gap: 0.2rem; }
    .spotlight-pip { width: 16px; height: 16px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 50%; box-shadow: 0 2px 3px rgba(0,0,0,0.3); transition: all 0.3s ease; }
    .spotlight-pip.empty { background: #1f2937; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5); }
    
    /* Combat Zones */
    .combat-zones-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 0.9rem; margin-top: 0.9rem; }
    .combat-zone {
      background: rgba(15, 23, 42, 0.7);
      padding: 0.9rem;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.25);
      min-height: 130px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.32);
    }
    .combat-zone-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.6rem;
      padding-bottom: 0.35rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }
    .combat-zone-name { font-weight: bold; font-size: 1rem; color: #fbbf24; cursor: text; flex: 1; padding: 0.25rem; background: transparent; border: none; }
    .combat-zone-name:hover { background: #1f2937; border-radius: 0.25rem; }
    .zone-tokens-container { display: flex; flex-direction: column; gap: 0.35rem; min-height: 60px; }
    .zone-token { background: #1f2937; padding: 0.4rem; border-radius: 0.375rem; cursor: move; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: all 0.2s; }
    .zone-token:hover { background: #111827; border-color: #3b82f6; }
    .zone-token.dragging { opacity: 0.5; }
    .zone-token.pc-token { border-left: 3px solid #16a34a; }
    .zone-token.adversary-token { border-left: 3px solid #dc2626; }
    .zone-token.custom-token { border-left: 3px solid #9333ea; }
    .zone-token.npc-token { border-left: 3px solid #3b82f6; }
    .token-name { font-size: 0.875rem; font-weight: 500; }
    .combat-zone.drag-over { background: #1f2937; border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
    .zone-controls { display: flex; gap: 0.5rem; margin-top: 0; flex-wrap: wrap; }
    .unassigned-tokens {
      border: 1px dashed rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.4);
      margin-top: 1rem;
    }
    .add-token-form {
      background: transparent;
      padding: 0;
      border-radius: 0;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 0.35rem;
    }
    .add-token-form select,
    .add-token-form input[type="text"] {
      padding: 0.45rem 0.65rem;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 0.5rem;
      color: var(--text-primary);
    }
    
    /* Streamer View */
    .streamer-view { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); min-height: 100vh; padding: 2rem; }
    .streamer-view .fear-tracker, .streamer-view .countdown-section, .streamer-view .spotlight-section, .streamer-view .combat-zones-section { background: rgba(31, 41, 55, 0.6); border: 3px solid #3b82f6; box-shadow: 0 0 40px rgba(59, 130, 246, 0.3); backdrop-filter: blur(10px); }
    .streamer-view .fear-token, .streamer-view .countdown-pip { width: 50px; height: 50px; }
    .streamer-view h2 { font-size: 2.4rem; margin-bottom: 1.4rem; text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
    .streamer-view h3 { font-size: 2rem; text-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
    .streamer-view .countdown-controls, .streamer-view .spotlight-controls, .streamer-view .zone-controls, .streamer-view .add-token-form, .streamer-view .delete-btn { display: none; }
    .streamer-view .countdown-item { background: #374151; padding: 1.05rem; border-radius: 0.5rem; margin-bottom: 0.75rem; border: 2px solid rgba(59, 130, 246, 0.3); }
    .streamer-view .countdown-item.at-zero { border: 2px solid #fbbf24; box-shadow: 0 0 30px rgba(251, 191, 36, 0.8); }
    .streamer-view .spotlight-pip { width: 40px; height: 40px; }
    .streamer-view .zone-token { cursor: default; }
    .streamer-view .countdown-item.warning-high { animation: streamerPulseSlowWarning 3.6s ease-in-out infinite; }
    .streamer-view .countdown-item.warning-medium { animation: streamerPulseMediumWarning 2.4s ease-in-out infinite; }
    .streamer-view .countdown-item.warning-critical { animation: streamerPulseFastWarning 1.2s ease-in-out infinite; }
    @keyframes streamerPulseSlowWarning { 0%, 100% { box-shadow: 0 0 0 rgba(251, 191, 36, 0); } 50% { box-shadow: 0 0 30px rgba(251, 191, 36, 0.8); } }
    @keyframes streamerPulseMediumWarning { 0%, 100% { box-shadow: 0 0 0 rgba(249, 115, 22, 0); } 50% { box-shadow: 0 0 35px rgba(249, 115, 22, 0.9); } }
    @keyframes streamerPulseFastWarning { 0%, 100% { box-shadow: 0 0 0 rgba(220, 38, 38, 0); } 50% { box-shadow: 0 0 40px rgba(220, 38, 38, 1); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üó°Ô∏è Daggerheart Campaign Manager</h1>
      <div class="btn-group">
        <button class="btn-primary" onclick="exportData()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
          Export Data
        </button>
        <label class="btn-primary btn-label">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
          Import Data
          <input type="file" accept=".json" onchange="importData(event)">
        </label>
        <label class="btn-purple btn-label">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
          Import Pools
          <input type="file" accept=".json" onchange="importPools(event)">
        </label>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('characters')">Characters</button>
      <button class="tab" onclick="switchTab('towns')">Towns</button>
      <button class="tab" onclick="switchTab('areas')">Areas</button>
      <button class="tab" onclick="switchTab('plotHooks')">Plot Hooks</button>
      <button class="tab" onclick="switchTab('loot')">Loot</button>
      <div style="flex: 1; min-width: 20px;"></div>
      <button class="tab tab-session" onclick="switchTab('session')">‚ö° Session View</button>
    </div>

    <div class="content">
      <div id="characters-tab">
        <div style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #374151;">
          <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Player Characters</h2>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <input type="text" id="pc-name" placeholder="PC Name" style="flex: 1; min-width: 200px; padding: 0.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            <select id="pc-class" style="padding: 0.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-width: 150px;">
              <option value="">Select Class</option>
              <option value="Guardian">Guardian</option>
              <option value="Ranger">Ranger</option>
              <option value="Seraph">Seraph</option>
              <option value="Warrior">Warrior</option>
              <option value="Bard">Bard</option>
              <option value="Druid">Druid</option>
              <option value="Rogue">Rogue</option>
              <option value="Sorcerer">Sorcerer</option>
              <option value="Wizard">Wizard</option>
            </select>
            <input type="number" id="pc-evasion" placeholder="Evasion" min="0" style="width: 120px; padding: 0.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            <button class="btn-green" onclick="addPC()">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              Add PC
            </button>
          </div>
          <div id="pc-list" style="display: grid; gap: 0.75rem; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));"></div>
        </div>

        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">NPCs</h2>
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <button class="btn-primary" onclick="generateNPC()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Generate NPC
          </button>
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" id="npc-search" placeholder="Search NPCs..." oninput="filterNPCs()">
          </div>
        </div>

        <div class="filters">
          <label class="checkbox-label">
            <input type="checkbox" id="filter-met" onchange="filterNPCs()">
            <span>Met Only</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="filter-unmet" onchange="filterNPCs()">
            <span>Unmet Only</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="filter-alive" onchange="filterNPCs()">
            <span>Alive/Unknown Only</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="filter-starred" onchange="filterNPCs()">
            <span>Starred Only</span>
          </label>
        </div>

        <div id="npc-generation"></div>
        <div id="npc-list"></div>
      </div>

      <div id="towns-tab" class="hidden">
        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Towns & Settlements</h2>
        <button class="btn-primary" onclick="generateTown()" style="margin-bottom: 1rem;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Generate Town
        </button>
        <div id="town-generation"></div>
        <div id="town-list"></div>
      </div>

      <div id="areas-tab" class="hidden">
        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Areas & Locations</h2>
        <button class="btn-primary" onclick="generateArea()" style="margin-bottom: 1rem;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Generate Area
        </button>
        <div id="area-generation"></div>
        <div id="area-list"></div>
      </div>

      <div id="plotHooks-tab" class="hidden">
        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Plot Hooks & Quests</h2>
        <button class="btn-primary" onclick="generateHook()" style="margin-bottom: 1rem;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Generate Plot Hook
        </button>
        <div id="hook-generation"></div>
        <div id="hook-list"></div>
      </div>

      <div id="loot-tab" class="hidden">
        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Loot Generator</h2>
        <div class="loot-grid">
          <div class="loot-tier-card">
            <div class="loot-tier-title">Minor Loot</div>
            <div class="loot-buttons">
              <button class="btn-gray" onclick="generateLoot('minor')">Generate Minor</button>
            </div>
          </div>
          <div class="loot-tier-card">
            <div class="loot-tier-title">Major Loot</div>
            <div class="loot-buttons">
              <button class="btn-blue" onclick="generateLoot('major')">Generate Major</button>
            </div>
          </div>
          <div class="loot-tier-card">
            <div class="loot-tier-title">Superior Loot</div>
            <div class="loot-buttons">
              <button class="btn-purple" onclick="generateLoot('superior')">Generate Superior</button>
            </div>
          </div>
        </div>
        <div id="loot-generation"></div>
        <div id="loot-list"></div>
      </div>

      <div id="session-tab" class="hidden">
        <div style="margin-bottom: 1.5rem;">
          <button class="btn-blue" onclick="openStreamerView()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            Open Streamer View
          </button>
        </div>

        <div class="session-container">
          <section class="session-section fear-tracker">
            <div class="session-section-header">
              <div class="session-heading-group">
                <span class="session-subtitle">Table Pulse</span>
                <h2 class="session-section-title">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M12 3v3m0 12v3m9-9h-3M6 12H3m15.364-6.364l-2.121 2.121M8.757 15.243l-2.12 2.121m12.727 0l-2.122-2.121M8.757 8.757L6.636 6.636"/></svg>
                  Fear
                </h2>
              </div>
              <div class="session-metric">
                <span id="fear-counter">0</span>
                <span>Max 12</span>
              </div>
            </div>
            <div class="session-divider"></div>
            <div id="fear-display" class="fear-tokens"></div>
            <div class="session-toolbar fear-controls">
              <button class="btn-primary" onclick="modifyFear(-1)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
                Spend Fear
              </button>
              <button class="btn-primary" onclick="modifyFear(1)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Add Fear
              </button>
            </div>
          </section>

          <section class="session-section countdown-section">
            <div class="session-section-header">
              <div class="session-heading-group">
                <span class="session-subtitle">Escalations</span>
                <h2 class="session-section-title">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M12 8v4l2.5 1.5M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Z"/></svg>
                  Countdowns
                </h2>
              </div>
            </div>
            <p style="color: var(--text-muted); font-size: 0.875rem;">Keep looming threats visible and adjust their pace on the fly.</p>
            <div class="session-divider"></div>

            <div class="add-countdown-form">
              <div class="form-field" style="flex: 2; min-width: 160px;">
                <label>Name</label>
                <input type="text" id="countdown-name" placeholder="Countdown name">
              </div>
              <div class="form-field" style="flex: 1; min-width: 110px;">
                <label>Max</label>
                <select id="countdown-max">
                  <option value="4">d4</option>
                  <option value="6" selected>d6</option>
                  <option value="8">d8</option>
                  <option value="10">d10</option>
                  <option value="12">d12</option>
                </select>
              </div>
              <button class="btn-green" onclick="addCountdown()" style="align-self: flex-end;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Add
              </button>
            </div>

            <div id="countdowns-list"></div>
          </section>

          <section class="session-section spotlight-section">
            <div class="session-section-header">
              <div class="session-heading-group">
                <span class="session-subtitle">Moments</span>
                <h2 class="session-section-title">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M12 3v18m9-9H3"/></svg>
                  Spotlight
                </h2>
              </div>
            </div>
            <p style="color: var(--text-muted); font-size: 0.875rem;">Queue up who deserves shine next and celebrate their evasion edge.</p>
            <div class="session-divider"></div>
            <div class="session-toolbar spotlight-controls">
              <select id="spotlight-pc-select">
                <option value="">Select PC</option>
              </select>
              <button class="btn-green" onclick="addSpotlightPlayer()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Add
              </button>
            </div>
            <div id="spotlight-list" class="spotlight-grid"></div>
          </section>

          <section class="session-section combat-zones-section">
            <div class="session-section-header">
              <div class="session-heading-group">
                <span class="session-subtitle">Engagements</span>
                <h2 class="session-section-title">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M4 7h16M4 12h16M4 17h16"/></svg>
                  Combat Zones
                </h2>
              </div>
            </div>
            <p style="color: var(--text-muted); font-size: 0.875rem;">Arrange battlefields, drag tokens between zones, and keep stragglers handy.</p>
            <div class="session-divider"></div>
            <div class="session-toolbar zone-controls">
              <button class="btn-green" onclick="addCombatZone()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Add Zone
              </button>
            </div>
            <div id="combat-zones-container" class="combat-zones-container"></div>

            <div class="session-subcard unassigned-tokens">
              <h3>Unassigned Tokens</h3>
              <div class="add-token-form">
                <select id="token-type">
                  <option value="adversary">Adversary</option>
                  <option value="custom">Custom</option>
                  <option value="npc">Saved NPC</option>
                </select>
                <input type="text" id="token-name" placeholder="Token name" style="flex: 1; min-width: 150px;">
                <select id="token-npc-select" class="hidden" style="flex: 1; min-width: 150px;">
                  <option value="">Select NPC</option>
                </select>
                <button class="btn-green" onclick="addCombatToken()">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                  Add Token
                </button>
              </div>
              <div id="unassigned-tokens" class="zone-tokens-container"></div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>


<script>
    // Data structure
    const DEFAULT_DATA = {
      pcs: [],
      npcs: [],
      towns: [],
      areas: [],
      plotHooks: [],
      loot: [],
      sessionState: {
        fear: 0,
        countdowns: [],
        spotlightPlayers: [],
        combatZones: [],
        combatTokens: []
      },
      namePool: { first: [], last: [] },
      townPool: [],
      areaPool: [],
      hookPool: []
    };

    let data = JSON.parse(JSON.stringify(DEFAULT_DATA));

    let currentGeneration = null;

    function ensureDataShape(raw = {}) {
      const source = (raw && typeof raw === 'object') ? raw : {};
      const normalized = {
        ...DEFAULT_DATA,
        ...source,
        pcs: Array.isArray(source.pcs)
          ? source.pcs.map(pc => {
              const normalizedPc = { ...pc };
              if (normalizedPc && Object.prototype.hasOwnProperty.call(normalizedPc, 'evasion')) {
                const evasionValue = Number(normalizedPc.evasion);
                if (Number.isFinite(evasionValue) && evasionValue >= 0) {
                  normalizedPc.evasion = Math.round(evasionValue);
                } else {
                  delete normalizedPc.evasion;
                }
              }
              const pcId = Number(normalizedPc.id);
              if (Number.isFinite(pcId)) {
                normalizedPc.id = pcId;
              }
              return normalizedPc;
            })
          : [],
        npcs: Array.isArray(source.npcs)
          ? source.npcs.map(npc => {
              const normalizedNpc = { ...npc };
              const npcId = Number(normalizedNpc.id);
              if (Number.isFinite(npcId)) {
                normalizedNpc.id = npcId;
              }
              return normalizedNpc;
            })
          : [],
        towns: Array.isArray(source.towns)
          ? source.towns.map(town => {
              const normalizedTown = { ...town };
              const townId = Number(normalizedTown.id);
              if (Number.isFinite(townId)) {
                normalizedTown.id = townId;
              }
              return normalizedTown;
            })
          : [],
        areas: Array.isArray(source.areas)
          ? source.areas.map(area => {
              const normalizedArea = { ...area };
              const areaId = Number(normalizedArea.id);
              if (Number.isFinite(areaId)) {
                normalizedArea.id = areaId;
              }
              return normalizedArea;
            })
          : [],
        plotHooks: Array.isArray(source.plotHooks)
          ? source.plotHooks.map(hook => {
              const normalizedHook = { ...hook };
              const hookId = Number(normalizedHook.id);
              if (Number.isFinite(hookId)) {
                normalizedHook.id = hookId;
              }
              return normalizedHook;
            })
          : [],
        loot: Array.isArray(source.loot)
          ? source.loot.map(item => {
              const normalizedItem = { ...item };
              const itemId = Number(normalizedItem.id);
              if (Number.isFinite(itemId)) {
                normalizedItem.id = itemId;
              }
              return normalizedItem;
            })
          : [],
        sessionState: {
          ...DEFAULT_DATA.sessionState,
          ...(source.sessionState && typeof source.sessionState === 'object' ? source.sessionState : {})
        },
        namePool: {
          ...DEFAULT_DATA.namePool,
          ...(source.namePool && typeof source.namePool === 'object' ? source.namePool : {})
        },
        townPool: Array.isArray(source.townPool) ? [...source.townPool] : [],
        areaPool: Array.isArray(source.areaPool) ? [...source.areaPool] : [],
        hookPool: Array.isArray(source.hookPool) ? [...source.hookPool] : []
      };

      const session = normalized.sessionState;
      const numericFear = Number(session.fear);
      session.fear = Number.isFinite(numericFear) ? Math.max(0, Math.min(12, Math.round(numericFear))) : 0;
      session.countdowns = Array.isArray(session.countdowns)
        ? session.countdowns.map(countdown => {
            const normalizedCountdown = { ...countdown };
            const max = Number(normalizedCountdown.max);
            const safeMax = Number.isFinite(max) && max > 0 ? Math.round(max) : 6;
            const current = Number(normalizedCountdown.current);
            normalizedCountdown.max = safeMax;
            normalizedCountdown.current = Number.isFinite(current)
              ? Math.max(0, Math.min(safeMax, Math.round(current)))
              : safeMax;
            const countdownId = Number(normalizedCountdown.id);
            if (Number.isFinite(countdownId)) {
              normalizedCountdown.id = countdownId;
            }
            return normalizedCountdown;
          })
        : [];
      session.spotlightPlayers = Array.isArray(session.spotlightPlayers)
        ? session.spotlightPlayers.map(player => {
            const normalizedPlayer = { ...player };
            const pips = Number(normalizedPlayer.pips);
            normalizedPlayer.pips = Number.isFinite(pips) ? Math.max(0, Math.min(6, Math.round(pips))) : 0;
            const playerId = Number(normalizedPlayer.id);
            if (Number.isFinite(playerId)) {
              normalizedPlayer.id = playerId;
            }
            return normalizedPlayer;
          })
        : [];
      session.combatZones = Array.isArray(session.combatZones)
        ? session.combatZones.map(zone => {
            const normalizedZone = { ...zone };
            const zoneId = Number(normalizedZone.id);
            if (Number.isFinite(zoneId)) {
              normalizedZone.id = zoneId;
            }
            normalizedZone.tokenIds = Array.isArray(normalizedZone.tokenIds)
              ? normalizedZone.tokenIds
                  .map(id => {
                    const numericId = Number(id);
                    return Number.isFinite(numericId) ? numericId : id;
                  })
              : [];
            return normalizedZone;
          })
        : [];
      session.combatTokens = Array.isArray(session.combatTokens)
        ? session.combatTokens.map(token => {
            const normalizedToken = { ...token };
            if (normalizedToken.zoneId === undefined || normalizedToken.zoneId === '') {
              normalizedToken.zoneId = null;
            } else {
              const zoneId = Number(normalizedToken.zoneId);
              normalizedToken.zoneId = Number.isFinite(zoneId) ? zoneId : null;
            }
            const tokenId = Number(normalizedToken.id);
            if (Number.isFinite(tokenId)) {
              normalizedToken.id = tokenId;
            }
            if (normalizedToken.pcId !== undefined) {
              const pcId = Number(normalizedToken.pcId);
              if (Number.isFinite(pcId)) {
                normalizedToken.pcId = pcId;
              }
            }
            return normalizedToken;
          })
        : [];

      normalized.namePool.first = Array.isArray(normalized.namePool.first)
        ? normalized.namePool.first.filter(name => typeof name === 'string' && name.trim() !== '')
        : [];
      normalized.namePool.last = Array.isArray(normalized.namePool.last)
        ? normalized.namePool.last.filter(name => typeof name === 'string' && name.trim() !== '')
        : [];
      normalized.townPool = Array.isArray(normalized.townPool)
        ? normalized.townPool.filter(name => typeof name === 'string' && name.trim() !== '')
        : [];
      normalized.areaPool = Array.isArray(normalized.areaPool)
        ? normalized.areaPool.filter(name => typeof name === 'string' && name.trim() !== '')
        : [];
      normalized.hookPool = Array.isArray(normalized.hookPool)
        ? normalized.hookPool.filter(name => typeof name === 'string' && name.trim() !== '')
        : [];

      return normalized;
    }

    // Storage functions
    function saveToStorage() {
      try {
        data = ensureDataShape(data);
        localStorage.setItem('daggerheartData', JSON.stringify(data));
      } catch (error) {
        console.error('Failed to save data', error);
      }
    }

    function loadFromStorage() {
      try {
        const saved = localStorage.getItem('daggerheartData');
        data = saved ? ensureDataShape(JSON.parse(saved)) : ensureDataShape({});
      } catch (error) {
        console.error('Failed to load data, using defaults', error);
        data = ensureDataShape({});
        saveToStorage();
      }
    }

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('[id$="-tab"]').forEach(t => t.classList.add('hidden'));

      // Find the tab button that was clicked
      const tabButton = Array.from(document.querySelectorAll('.tab')).find(
        tab => tab.textContent.toLowerCase().includes(tabName) ||
               tab.getAttribute('onclick')?.includes(`'${tabName}'`)
      );
      if (tabButton) {
        tabButton.classList.add('active');
      }

      document.getElementById(`${tabName}-tab`).classList.remove('hidden');

      if (tabName === 'session') {
        renderSessionView();
      }
    }

    // PC Functions
    function addPC() {
      const name = document.getElementById('pc-name').value.trim();
      const pcClass = document.getElementById('pc-class').value;
      const evasionInput = document.getElementById('pc-evasion');
      const evasionRaw = evasionInput.value.trim();
      let evasionValue = null;

      if (evasionRaw !== '') {
        const parsed = parseInt(evasionRaw, 10);
        if (isNaN(parsed) || parsed < 0) {
          alert('Please enter a valid evasion score (0 or higher).');
          return;
        }
        evasionValue = parsed;
      }

      if (!name || !pcClass) {
        alert('Please enter both name and class');
        return;
      }

      const newPc = {
        id: Date.now(),
        name,
        class: pcClass
      };

      if (evasionValue !== null) {
        newPc.evasion = evasionValue;
      }

      data.pcs.push(newPc);

      saveToStorage();
      renderPCs();
      populateSpotlightSelect();
      renderCombatZones();

      document.getElementById('pc-name').value = '';
      document.getElementById('pc-class').value = '';
      evasionInput.value = '';
    }

    function deletePC(id) {
      if (confirm('Delete this PC?')) {
        data.pcs = data.pcs.filter(pc => pc.id !== id);
        saveToStorage();
        renderPCs();
      }
    }

    function updatePCEvasion(id, value) {
      const pc = data.pcs.find(pc => pc.id === id);
      if (!pc) return;

      const trimmed = String(value ?? '').trim();

      if (trimmed === '') {
        delete pc.evasion;
      } else {
        const parsed = parseInt(trimmed, 10);
        if (isNaN(parsed) || parsed < 0) {
          return;
        }
        pc.evasion = parsed;
      }

      saveToStorage();
      renderPCs();
      renderSpotlightTracker();
      populateSpotlightSelect();
      renderCombatZones();
    }

    function renderPCs() {
      const container = document.getElementById('pc-list');
      if (data.pcs.length === 0) {
        container.innerHTML = '<p class="empty-state">No PCs added yet</p>';
        return;
      }

      container.innerHTML = data.pcs.map(pc => {
        const evasion = typeof pc.evasion === 'number' ? pc.evasion : (pc.evasion !== undefined ? parseInt(pc.evasion, 10) : null);
        const evasionValue = Number.isNaN(evasion) ? '' : (evasion ?? '');

        return `
          <div style="background: #374151; padding: 0.75rem 1rem; border-radius: 0.375rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="display: flex; flex-direction: column; gap: 0.25rem; flex: 1; min-width: 140px;">
              <span style="font-weight: 600; font-size: 1rem;">${pc.name}</span>
              <span style="color: #9ca3af; font-size: 0.875rem;">${pc.class}</span>
            </div>
            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #d1d5db;">
              <span style="color: #9ca3af;">Evasion</span>
              <input type="number"
                     min="0"
                     value="${evasionValue === '' ? '' : evasionValue}"
                     placeholder="-"
                     onchange="updatePCEvasion(${pc.id}, this.value)"
                     style="width: 80px; padding: 0.35rem 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </label>
            <button class="delete-btn" onclick="deletePC(${pc.id})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        `;
      }).join('');
    }

    function getPcDisplayName(pc) {
      if (!pc) return 'Unknown PC';
      const rawEvasion = pc.evasion;
      const numeric = typeof rawEvasion === 'number' ? rawEvasion : parseInt(rawEvasion, 10);
      const hasEvasion = rawEvasion !== undefined && rawEvasion !== null && !Number.isNaN(numeric);
      return hasEvasion ? `${pc.name} (Ev ${numeric})` : pc.name;
    }

    // NPC Functions
    function generateNPC() {
      const first = data.namePool.first.length > 0 
        ? data.namePool.first[Math.floor(Math.random() * data.namePool.first.length)]
        : 'Generated';
      const last = data.namePool.last.length > 0
        ? data.namePool.last[Math.floor(Math.random() * data.namePool.last.length)]
        : 'NPC';
      
      currentGeneration = {
        type: 'npc',
        data: {
          id: Date.now(),
          name: `${first} ${last}`,
          role: 'Unknown Role',
          description: 'A mysterious individual...',
          status: 'Unknown',
          met: false,
          starred: false
        }
      };
      
      renderNPCGeneration();
    }

    function renderNPCGeneration() {
      const container = document.getElementById('npc-generation');
      
      if (!currentGeneration || currentGeneration.type !== 'npc') {
        container.innerHTML = '';
        return;
      }
      
      const npc = currentGeneration.data;
      
      container.innerHTML = `
        <div class="generation-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: bold;">Generated NPC</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-green" onclick="saveNPC()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Save
              </button>
              <button class="btn-gray" onclick="clearGeneration()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                Discard
              </button>
            </div>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Name</label>
              <input type="text" value="${npc.name}" onchange="currentGeneration.data.name = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Role</label>
              <input type="text" value="${npc.role}" onchange="currentGeneration.data.role = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Description</label>
              <textarea onchange="currentGeneration.data.description = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-height: 100px;">${npc.description}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function saveNPC() {
      if (currentGeneration && currentGeneration.type === 'npc') {
        data.npcs.push(currentGeneration.data);
        saveToStorage();
        currentGeneration = null;
        renderNPCGeneration();
        renderNPCList();
        filterNPCs();
      }
    }

    function toggleNPCStatus(id, field) {
      const npc = data.npcs.find(n => n.id === id);
      if (!npc) return;
      
      if (field === 'met') {
        npc.met = !npc.met;
      } else if (field === 'starred') {
        npc.starred = !npc.starred;
      } else if (field === 'status') {
        const statuses = ['Alive', 'Dead', 'Unknown'];
        const currentIndex = statuses.indexOf(npc.status);
        npc.status = statuses[(currentIndex + 1) % statuses.length];
      }
      
      saveToStorage();
      filterNPCs();
    }

    function deleteNPC(id) {
      if (confirm('Delete this NPC?')) {
        data.npcs = data.npcs.filter(n => n.id !== id);
        saveToStorage();
        filterNPCs();
      }
    }

    function renderNPCList() {
      const container = document.getElementById('npc-list');
      if (data.npcs.length === 0) {
        container.innerHTML = '<p class="empty-state">No NPCs yet. Generate some!</p>';
        return;
      }
      
      container.innerHTML = data.npcs.map(npc => `
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">${npc.name}</div>
              <div style="color: #9ca3af; font-size: 0.875rem;">${npc.role}</div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <span class="star ${npc.starred ? '' : 'inactive'}" onclick="toggleNPCStatus(${npc.id}, 'starred')">‚òÖ</span>
              <span class="status-badge status-${npc.status.toLowerCase()}" onclick="toggleNPCStatus(${npc.id}, 'status')" style="cursor: pointer;">${npc.status}</span>
              <span class="status-badge status-${npc.met ? 'met' : 'unmet'}" onclick="toggleNPCStatus(${npc.id}, 'met')" style="cursor: pointer;">${npc.met ? 'Met' : 'Unmet'}</span>
              <button class="delete-btn" onclick="deleteNPC(${npc.id})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>
          </div>
          <div class="card-content">${npc.description}</div>
        </div>
      `).join('');
    }

    function filterNPCs() {
      const searchTerm = document.getElementById('npc-search').value.toLowerCase();
      const filterMet = document.getElementById('filter-met').checked;
      const filterUnmet = document.getElementById('filter-unmet').checked;
      const filterAlive = document.getElementById('filter-alive').checked;
      const filterStarred = document.getElementById('filter-starred').checked;
      
      let filtered = data.npcs.filter(npc => {
        const matchesSearch = npc.name.toLowerCase().includes(searchTerm) || 
                            npc.role.toLowerCase().includes(searchTerm) ||
                            npc.description.toLowerCase().includes(searchTerm);
        
        const matchesMet = !filterMet || npc.met;
        const matchesUnmet = !filterUnmet || !npc.met;
        const matchesAlive = !filterAlive || (npc.status === 'Alive' || npc.status === 'Unknown');
        const matchesStarred = !filterStarred || npc.starred;
        
        return matchesSearch && matchesMet && matchesUnmet && matchesAlive && matchesStarred;
      });
      
      const container = document.getElementById('npc-list');
      if (filtered.length === 0) {
        container.innerHTML = '<p class="empty-state">No NPCs match your filters</p>';
        return;
      }
      
      container.innerHTML = filtered.map(npc => `
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">${npc.name}</div>
              <div style="color: #9ca3af; font-size: 0.875rem;">${npc.role}</div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <span class="star ${npc.starred ? '' : 'inactive'}" onclick="toggleNPCStatus(${npc.id}, 'starred')">‚òÖ</span>
              <span class="status-badge status-${npc.status.toLowerCase()}" onclick="toggleNPCStatus(${npc.id}, 'status')" style="cursor: pointer;">${npc.status}</span>
              <span class="status-badge status-${npc.met ? 'met' : 'unmet'}" onclick="toggleNPCStatus(${npc.id}, 'met')" style="cursor: pointer;">${npc.met ? 'Met' : 'Unmet'}</span>
              <button class="delete-btn" onclick="deleteNPC(${npc.id})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>
          </div>
          <div class="card-content">${npc.description}</div>
        </div>
      `).join('');
    }

    // Town Functions
    function generateTown() {
      const townName = data.townPool.length > 0
        ? data.townPool[Math.floor(Math.random() * data.townPool.length)]
        : 'New Settlement';
      
      currentGeneration = {
        type: 'town',
        data: {
          id: Date.now(),
          name: townName,
          description: 'A settlement in the realm...'
        }
      };
      
      renderTownGeneration();
    }

    function renderTownGeneration() {
      const container = document.getElementById('town-generation');
      
      if (!currentGeneration || currentGeneration.type !== 'town') {
        container.innerHTML = '';
        return;
      }
      
      const town = currentGeneration.data;
      
      container.innerHTML = `
        <div class="generation-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: bold;">Generated Town</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-green" onclick="saveTown()">Save</button>
              <button class="btn-gray" onclick="clearGeneration()">Discard</button>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Name</label>
              <input type="text" value="${town.name}" onchange="currentGeneration.data.name = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Description</label>
              <textarea onchange="currentGeneration.data.description = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-height: 100px;">${town.description}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function saveTown() {
      if (currentGeneration && currentGeneration.type === 'town') {
        data.towns.push(currentGeneration.data);
        saveToStorage();
        currentGeneration = null;
        renderTownGeneration();
        renderTownList();
      }
    }

    function deleteTown(id) {
      if (confirm('Delete this town?')) {
        data.towns = data.towns.filter(t => t.id !== id);
        saveToStorage();
        renderTownList();
      }
    }

    function renderTownList() {
      const container = document.getElementById('town-list');
      if (data.towns.length === 0) {
        container.innerHTML = '<p class="empty-state">No towns yet</p>';
        return;
      }
      
      container.innerHTML = data.towns.map(town => `
        <div class="card">
          <div class="card-header">
            <div class="card-title">${town.name}</div>
            <button class="delete-btn" onclick="deleteTown(${town.id})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
          <div class="card-content">${town.description}</div>
        </div>
      `).join('');
    }

    // Area Functions
    function generateArea() {
      const areaName = data.areaPool.length > 0
        ? data.areaPool[Math.floor(Math.random() * data.areaPool.length)]
        : 'Mysterious Location';
      
      currentGeneration = {
        type: 'area',
        data: {
          id: Date.now(),
          name: areaName,
          description: 'An interesting location...'
        }
      };
      
      renderAreaGeneration();
    }

    function renderAreaGeneration() {
      const container = document.getElementById('area-generation');
      
      if (!currentGeneration || currentGeneration.type !== 'area') {
        container.innerHTML = '';
        return;
      }
      
      const area = currentGeneration.data;
      
      container.innerHTML = `
        <div class="generation-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: bold;">Generated Area</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-green" onclick="saveArea()">Save</button>
              <button class="btn-gray" onclick="clearGeneration()">Discard</button>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Name</label>
              <input type="text" value="${area.name}" onchange="currentGeneration.data.name = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Description</label>
              <textarea onchange="currentGeneration.data.description = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-height: 100px;">${area.description}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function saveArea() {
      if (currentGeneration && currentGeneration.type === 'area') {
        data.areas.push(currentGeneration.data);
        saveToStorage();
        currentGeneration = null;
        renderAreaGeneration();
        renderAreaList();
      }
    }

    function deleteArea(id) {
      if (confirm('Delete this area?')) {
        data.areas = data.areas.filter(a => a.id !== id);
        saveToStorage();
        renderAreaList();
      }
    }

    function renderAreaList() {
      const container = document.getElementById('area-list');
      if (data.areas.length === 0) {
        container.innerHTML = '<p class="empty-state">No areas yet</p>';
        return;
      }
      
      container.innerHTML = data.areas.map(area => `
        <div class="card">
          <div class="card-header">
            <div class="card-title">${area.name}</div>
            <button class="delete-btn" onclick="deleteArea(${area.id})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
          <div class="card-content">${area.description}</div>
        </div>
      `).join('');
    }
// Plot Hook Functions
    function generateHook() {
      const hookText = data.hookPool.length > 0
        ? data.hookPool[Math.floor(Math.random() * data.hookPool.length)]
        : 'A mysterious quest appears...';
      
      currentGeneration = {
        type: 'hook',
        data: {
          id: Date.now(),
          title: 'New Plot Hook',
          description: hookText
        }
      };
      
      renderHookGeneration();
    }

    function renderHookGeneration() {
      const container = document.getElementById('hook-generation');
      
      if (!currentGeneration || currentGeneration.type !== 'hook') {
        container.innerHTML = '';
        return;
      }
      
      const hook = currentGeneration.data;
      
      container.innerHTML = `
        <div class="generation-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: bold;">Generated Plot Hook</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-green" onclick="saveHook()">Save</button>
              <button class="btn-gray" onclick="clearGeneration()">Discard</button>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Title</label>
              <input type="text" value="${hook.title}" onchange="currentGeneration.data.title = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Description</label>
              <textarea onchange="currentGeneration.data.description = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-height: 100px;">${hook.description}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function saveHook() {
      if (currentGeneration && currentGeneration.type === 'hook') {
        data.plotHooks.push(currentGeneration.data);
        saveToStorage();
        currentGeneration = null;
        renderHookGeneration();
        renderHookList();
      }
    }

    function deleteHook(id) {
      if (confirm('Delete this plot hook?')) {
        data.plotHooks = data.plotHooks.filter(h => h.id !== id);
        saveToStorage();
        renderHookList();
      }
    }

    function renderHookList() {
      const container = document.getElementById('hook-list');
      if (data.plotHooks.length === 0) {
        container.innerHTML = '<p class="empty-state">No plot hooks yet</p>';
        return;
      }
      
      container.innerHTML = data.plotHooks.map(hook => `
        <div class="card">
          <div class="card-header">
            <div class="card-title">${hook.title}</div>
            <button class="delete-btn" onclick="deleteHook(${hook.id})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
          <div class="card-content">${hook.description}</div>
        </div>
      `).join('');
    }

    // Loot Functions
    function generateLoot(tier) {
      currentGeneration = {
        type: 'loot',
        data: {
          id: Date.now(),
          name: `${tier.charAt(0).toUpperCase() + tier.slice(1)} Item`,
          effect: 'Magical effect...',
          tier
        }
      };
      
      renderLootGeneration();
    }

    function renderLootGeneration() {
      const container = document.getElementById('loot-generation');
      
      if (!currentGeneration || currentGeneration.type !== 'loot') {
        container.innerHTML = '';
        return;
      }
      
      const loot = currentGeneration.data;
      
      container.innerHTML = `
        <div class="generation-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: bold;">Generated ${loot.tier} Loot</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-green" onclick="saveLoot()">Save</button>
              <button class="btn-gray" onclick="clearGeneration()">Discard</button>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Name</label>
              <input type="text" value="${loot.name}" onchange="currentGeneration.data.name = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Effect</label>
              <textarea onchange="currentGeneration.data.effect = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-height: 100px;">${loot.effect}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function saveLoot() {
      if (currentGeneration && currentGeneration.type === 'loot') {
        data.loot.push(currentGeneration.data);
        saveToStorage();
        currentGeneration = null;
        renderLootGeneration();
        renderLootList();
      }
    }

    function deleteLoot(id) {
      if (confirm('Delete this loot?')) {
        data.loot = data.loot.filter(l => l.id !== id);
        saveToStorage();
        renderLootList();
      }
    }

    function renderLootList() {
      const container = document.getElementById('loot-list');
      if (data.loot.length === 0) {
        container.innerHTML = '<p class="empty-state">No saved loot yet</p>';
        return;
      }
      
      container.innerHTML = data.loot.map(loot => `
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">${loot.name}</div>
              <span class="status-badge" style="background: #9333ea; color: white;">${loot.tier}</span>
            </div>
            <button class="delete-btn" onclick="deleteLoot(${loot.id})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
          <div class="card-content">${loot.effect}</div>
        </div>
      `).join('');
    }

    function clearGeneration() {
      currentGeneration = null;
      renderNPCGeneration();
      renderTownGeneration();
      renderAreaGeneration();
      renderHookGeneration();
      renderLootGeneration();
    }

    // Session View Functions
    function renderSessionView() {
      renderFearTracker();
      renderCountdowns();
      renderSpotlightTracker();
      renderCombatZones();
      populateSpotlightSelect();
      populateNPCSelect();
    }

    function renderFearTracker() {
      const container = document.getElementById('fear-display');
      const counter = document.getElementById('fear-counter');
      const fear = data.sessionState.fear;

      if (counter) {
        counter.textContent = fear;
      }

      if (!container) return;

      let html = '';

      for (let i = 0; i < 12; i++) {
        const filled = i < fear;
        html += `<div class="fear-token ${filled ? '' : 'empty'}"></div>`;
      }

      container.innerHTML = html;
    }

    function modifyFear(delta) {
      const newFear = Math.max(0, Math.min(12, data.sessionState.fear + delta));
      if (newFear === data.sessionState.fear) return;
      
      data.sessionState.fear = newFear;
      
      if (delta < 0) {
        localStorage.setItem('fearAction', JSON.stringify({
          type: 'spend',
          timestamp: Date.now()
        }));
      }
      
      saveToStorage();
      
      const container = document.getElementById('fear-display');
      if (!container) return;
      const tokens = container.querySelectorAll('.fear-token');
      
      if (delta < 0) {
        const tokenIndex = newFear;
        if (tokens[tokenIndex]) {
          tokens[tokenIndex].classList.add('spending');
          setTimeout(() => {
            renderFearTracker();
          }, 600);
        }
      } else {
        renderFearTracker();
        const tokenIndex = newFear - 1;
        const newTokens = container.querySelectorAll('.fear-token');
        if (newTokens[tokenIndex]) {
          newTokens[tokenIndex].classList.add('gaining');
        }
      }
    }

    function addCountdown() {
      const name = document.getElementById('countdown-name').value.trim();
      const max = parseInt(document.getElementById('countdown-max').value);
      
      if (!name) {
        alert('Please enter a countdown name');
        return;
      }
      
      data.sessionState.countdowns.push({
        id: Date.now(),
        name,
        current: max,
        max
      });
      
      saveToStorage();
      renderCountdowns();
      
      document.getElementById('countdown-name').value = '';
    }

    function modifyCountdown(id, delta) {
      const countdown = data.sessionState.countdowns.find(c => c.id === id);
      if (!countdown) return;
      
      const newValue = Math.max(0, Math.min(countdown.max, countdown.current + delta));
      if (newValue === countdown.current) return;
      
      const oldValue = countdown.current;
      countdown.current = newValue;
      saveToStorage();
      
      setTimeout(() => {
        renderCountdowns();
        const item = document.querySelector(`[data-countdown-id="${id}"]`);
        if (!item) return;
        
        const pips = item.querySelectorAll('.countdown-pip');
        if (delta < 0) {
          const pipIndex = newValue;
          if (pips[pipIndex]) {
            pips[pipIndex].classList.add('decreasing');
          }
        } else {
          const pipIndex = newValue - 1;
          if (pips[pipIndex]) {
            pips[pipIndex].classList.add('increasing');
          }
        }
        
        if (newValue === 0 && oldValue !== 0) {
          item.classList.add('at-zero');
        }
      }, 50);
    }

    function deleteCountdown(id) {
      if (confirm('Delete this countdown?')) {
        data.sessionState.countdowns = data.sessionState.countdowns.filter(c => c.id !== id);
        saveToStorage();
        renderCountdowns();
      }
    }

    function renderCountdowns() {
      const container = document.getElementById('countdowns-list');
      if (!container) return;
      
      const countdowns = Array.isArray(data.sessionState.countdowns) ? data.sessionState.countdowns : [];

      if (countdowns.length === 0) {
        container.innerHTML = '<p class="empty-state" style="text-align: center;">No countdowns active.</p>';
        return;
      }

      container.innerHTML = countdowns.map(countdown => {
        const percentage = (countdown.current / countdown.max) * 100;
        let warningClass = '';
        
        if (countdown.current === 0) {
          warningClass = 'at-zero';
        } else if (percentage <= 25) {
          warningClass = 'warning-critical';
        } else if (percentage <= 50) {
          warningClass = 'warning-medium';
        } else if (percentage <= 75) {
          warningClass = 'warning-high';
        }
        
        return `
          <div class="countdown-item ${warningClass}" data-countdown-id="${countdown.id}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <h3 style="font-weight: bold; font-size: 1.125rem;">${countdown.name}</h3>
              <button class="delete-btn" onclick="deleteCountdown(${countdown.id})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="countdown-display">
              ${Array.from({length: countdown.max}, (_, i) => 
                `<div class="countdown-pip ${i < countdown.current ? '' : 'empty'}"></div>`
              ).join('')}
            </div>
            <div class="countdown-controls">
              <button class="btn-primary" onclick="modifyCountdown(${countdown.id}, -1)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
              </button>
              <span style="font-weight: bold; font-size: 1.25rem;">${countdown.current} / ${countdown.max}</span>
              <button class="btn-primary" onclick="modifyCountdown(${countdown.id}, 1)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function populateSpotlightSelect() {
      const select = document.getElementById('spotlight-pc-select');
      if (!select) return;
      
      const alreadyInSpotlight = data.sessionState.spotlightPlayers.map(p => p.pcId);
      const availablePCs = data.pcs.filter(pc => !alreadyInSpotlight.includes(pc.id));
      
      select.innerHTML = '<option value="">Select PC</option>' +
        availablePCs.map(pc => `<option value="${pc.id}">${getPcDisplayName(pc)}</option>`).join('');
    }

    function addSpotlightPlayer() {
      const select = document.getElementById('spotlight-pc-select');
      const pcId = parseInt(select.value);
      
      if (!pcId) {
        alert('Please select a PC');
        return;
      }
      
      const pc = data.pcs.find(p => p.id === pcId);
      if (!pc) return;
      
      data.sessionState.spotlightPlayers.push({
        id: Date.now(),
        pcId: pc.id,
        name: pc.name,
        pips: 0
      });
      
      saveToStorage();
      renderSpotlightTracker();
      populateSpotlightSelect();
    }

    function modifySpotlight(id, delta) {
      const player = data.sessionState.spotlightPlayers.find(p => p.id === id);
      if (!player) return;
      
      player.pips = Math.max(0, Math.min(6, player.pips + delta));
      saveToStorage();
      renderSpotlightTracker();
    }

    function removeSpotlight(id) {
      data.sessionState.spotlightPlayers = data.sessionState.spotlightPlayers.filter(p => p.id !== id);
      saveToStorage();
      renderSpotlightTracker();
      populateSpotlightSelect();
    }

    function renderSpotlightTracker() {
      const container = document.getElementById('spotlight-list');
      if (!container) return;
      
      const spotlightPlayers = Array.isArray(data.sessionState.spotlightPlayers) ? data.sessionState.spotlightPlayers : [];

      if (spotlightPlayers.length === 0) {
        container.innerHTML = '<p class="empty-state" style="grid-column: 1/-1; text-align: center;">No players in spotlight tracker.</p>';
        return;
      }

      container.innerHTML = spotlightPlayers.map(player => {
        const pc = data.pcs.find(p => p.id === player.pcId);
        const displayName = pc ? getPcDisplayName(pc) : player.name;

        return `
          <div class="spotlight-player">
            <div class="spotlight-info">
              <div class="spotlight-name">${displayName}</div>
              <div class="spotlight-pips">
                ${Array.from({length: 6}, (_, i) =>
                  `<div class="spotlight-pip ${i < player.pips ? '' : 'empty'}"></div>`
                ).join('')}
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <button class="btn-gray" onclick="modifySpotlight(${player.id}, -1)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
              </button>
              <button class="btn-gray" onclick="modifySpotlight(${player.id}, 1)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              </button>
              <button class="delete-btn" onclick="removeSpotlight(${player.id})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
// Combat Zones Functions
    function addCombatZone() {
      if (data.sessionState.combatZones.length >= 5) {
        alert('Maximum of 5 combat zones allowed');
        return;
      }
      
      data.sessionState.combatZones.push({
        id: Date.now(),
        name: `Zone ${data.sessionState.combatZones.length + 1}`,
        tokenIds: []
      });
      
      saveToStorage();
      renderCombatZones();
    }

    function deleteCombatZone(zoneId) {
      if (confirm('Delete this zone? Tokens will be moved to Unassigned.')) {
        const zone = data.sessionState.combatZones.find(z => z.id === zoneId);
        if (zone) {
          zone.tokenIds.forEach(tokenId => {
            const token = data.sessionState.combatTokens.find(t => t.id === tokenId);
            if (token) {
              token.zoneId = null;
            }
          });
        }
        
        data.sessionState.combatZones = data.sessionState.combatZones.filter(z => z.id !== zoneId);
        saveToStorage();
        renderCombatZones();
      }
    }

    function renameCombatZone(zoneId, newName) {
      const zone = data.sessionState.combatZones.find(z => z.id === zoneId);
      if (zone) {
        zone.name = newName || `Zone ${data.sessionState.combatZones.indexOf(zone) + 1}`;
        saveToStorage();
      }
    }

    function addCombatToken() {
      const type = document.getElementById('token-type').value;
      const nameInput = document.getElementById('token-name');
      const npcSelect = document.getElementById('token-npc-select');
      
      let name = '';
      if (type === 'npc') {
        const npcId = parseInt(npcSelect.value);
        if (!npcId) {
          alert('Please select an NPC');
          return;
        }
        const npc = data.npcs.find(n => n.id === npcId);
        name = npc ? npc.name : 'Unknown NPC';
      } else {
        name = nameInput.value.trim();
        if (!name) {
          alert('Please enter a token name');
          return;
        }
      }
      
      data.sessionState.combatTokens.push({
        id: Date.now(),
        name,
        type,
        zoneId: null
      });
      
      saveToStorage();
      renderCombatZones();
      
      nameInput.value = '';
      npcSelect.value = '';
    }

    function deleteCombatToken(tokenId) {
      if (confirm('Delete this token?')) {
        data.sessionState.combatTokens = data.sessionState.combatTokens.filter(t => t.id !== tokenId);
        
        data.sessionState.combatZones.forEach(zone => {
          zone.tokenIds = zone.tokenIds.filter(id => id !== tokenId);
        });
        
        saveToStorage();
        renderCombatZones();
      }
    }

    function handleTokenDragStart(e, tokenId) {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', tokenId);
      e.target.classList.add('dragging');
    }

    function handleTokenDragEnd(e) {
      e.target.classList.remove('dragging');
    }

    function handleZoneDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      e.currentTarget.classList.add('drag-over');
    }

    function handleZoneDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function handleZoneDrop(e, targetZoneId) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      const tokenId = e.dataTransfer.getData('text/plain');
      
      if (tokenId.startsWith('pc-')) {
        const pcId = parseInt(tokenId.replace('pc-', ''));
        const pc = data.pcs.find(p => p.id === pcId);
        if (!pc) return;
        
        let token = data.sessionState.combatTokens.find(t => t.pcId === pcId);
        if (!token) {
          token = {
            id: Date.now(),
            name: pc.name,
            type: 'pc',
            pcId: pcId,
            zoneId: null
          };
          data.sessionState.combatTokens.push(token);
        }
        
        if (token.zoneId) {
          const oldZone = data.sessionState.combatZones.find(z => z.id === token.zoneId);
          if (oldZone) {
            oldZone.tokenIds = oldZone.tokenIds.filter(id => id !== token.id);
          }
        }
        
        token.zoneId = targetZoneId;
        if (targetZoneId) {
          const newZone = data.sessionState.combatZones.find(z => z.id === targetZoneId);
          if (newZone && !newZone.tokenIds.includes(token.id)) {
            newZone.tokenIds.push(token.id);
          }
        }
      } else {
        const numTokenId = parseInt(tokenId);
        const token = data.sessionState.combatTokens.find(t => t.id === numTokenId);
        
        if (!token) return;
        
        if (token.zoneId) {
          const oldZone = data.sessionState.combatZones.find(z => z.id === token.zoneId);
          if (oldZone) {
            oldZone.tokenIds = oldZone.tokenIds.filter(id => id !== numTokenId);
          }
        }
        
        token.zoneId = targetZoneId;
        if (targetZoneId) {
          const newZone = data.sessionState.combatZones.find(z => z.id === targetZoneId);
          if (newZone && !newZone.tokenIds.includes(numTokenId)) {
            newZone.tokenIds.push(numTokenId);
          }
        }
      }
      
      saveToStorage();
      renderCombatZones();
    }

    function renderCombatZones() {
      const container = document.getElementById('combat-zones-container');
      const unassignedContainer = document.getElementById('unassigned-tokens');
      
      if (!container || !unassignedContainer) return;
      
      const zones = Array.isArray(data.sessionState.combatZones) ? data.sessionState.combatZones : [];
      const combatTokens = Array.isArray(data.sessionState.combatTokens) ? data.sessionState.combatTokens : [];
      if (zones.length === 0) {
        container.innerHTML = '<p class="empty-state" style="grid-column: 1/-1; text-align: center;">No combat zones. Add one to get started!</p>';
      } else {
        container.innerHTML = zones.map(zone => {
          const tokens = (zone.tokenIds || [])
            .map(tokenId => combatTokens.find(t => t.id === tokenId))
            .filter(t => t);

          const zoneTokensHtml = tokens.length === 0
            ? '<p class="empty-state" style="text-align: center; padding: 1rem; font-size: 0.875rem;">Drop tokens here</p>'
            : tokens.map(token => {
                const tokenType = token.type || 'custom';
                const displayName = tokenType === 'pc'
                  ? (() => {
                      const pc = data.pcs.find(p => p.id === token.pcId);
                      return pc ? getPcDisplayName(pc) : token.name;
                    })()
                  : token.name;

                return `
                    <div class="zone-token ${tokenType}-token"
                         draggable="true"
                         ondragstart="handleTokenDragStart(event, ${token.id})"
                         ondragend="handleTokenDragEnd(event)">
                      <span class="token-name">${displayName}</span>
                      <button class="delete-btn" onclick="deleteCombatToken(${token.id})">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                      </button>
                    </div>
                  `;
              }).join('');

          return `
            <div class="combat-zone"
                 ondragover="handleZoneDragOver(event)"
                 ondragleave="handleZoneDragLeave(event)"
                 ondrop="handleZoneDrop(event, ${zone.id})">
              <div class="combat-zone-header">
                <input
                  type="text"
                  class="combat-zone-name"
                  value="${zone.name}"
                  onblur="renameCombatZone(${zone.id}, this.value)"
                  onkeypress="if(event.key === 'Enter') this.blur()">
                <button class="delete-btn" onclick="deleteCombatZone(${zone.id})">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
              <div class="zone-tokens-container">
                ${zoneTokensHtml}
              </div>
            </div>
          `;
        }).join('');
      }

      const unassignedTokens = combatTokens.filter(t => !t.zoneId);

      const assignedPcIds = combatTokens
        .filter(t => t.pcId && t.zoneId)
        .map(t => t.pcId);

      const pcTokens = data.pcs
        .filter(pc => !assignedPcIds.includes(pc.id))
        .map(pc => ({
          id: `pc-${pc.id}`,
          name: getPcDisplayName(pc),
          type: 'pc',
          isPc: true,
          pcId: pc.id
        }));

      const allUnassigned = [...pcTokens, ...unassignedTokens];

      const unassignedHtml = allUnassigned.length === 0
        ? '<p class="empty-state" style="text-align: center; padding: 1rem; font-size: 0.875rem;">No unassigned tokens</p>'
        : allUnassigned.map(token => {
            const tokenType = token.type || (token.isPc ? 'pc' : 'custom');
            const displayName = tokenType === 'pc'
              ? (() => {
                  const pcId = token.pcId !== undefined ? token.pcId : null;
                  const pc = pcId ? data.pcs.find(p => p.id === pcId) : null;
                  return pc ? getPcDisplayName(pc) : token.name;
                })()
              : token.name;

            return `
            <div class="zone-token ${tokenType}-token"
                 draggable="true"
                 ondragstart="handleTokenDragStart(event, ${token.isPc ? `'${token.id}'` : token.id})"
                 ondragend="handleTokenDragEnd(event)">
              <span class="token-name">${displayName}</span>
              ${!token.isPc ? `
                <button class="delete-btn" onclick="deleteCombatToken(${token.id})">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              ` : ''}
            </div>
          `;
          }).join('');

      unassignedContainer.innerHTML = `
        <div style="padding: 0.5rem;"
             ondragover="handleZoneDragOver(event)"
             ondragleave="handleZoneDragLeave(event)"
             ondrop="handleZoneDrop(event, null)">
          ${unassignedHtml}
        </div>
      `;
    }

    function populateNPCSelect() {
      const select = document.getElementById('token-npc-select');
      if (!select) return;
      
      const npcs = data.npcs.filter(npc => npc.status !== 'Dead');
      select.innerHTML = '<option value="">Select NPC</option>' +
        npcs.map(npc => `<option value="${npc.id}">${npc.name}</option>`).join('');
    }

    // Import/Export Functions
    function exportData() {
      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `daggerheart-campaign-${Date.now()}.json`;
      link.click();
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          data = ensureDataShape(JSON.parse(e.target.result));
          saveToStorage();
          location.reload();
        } catch (error) {
          alert('Invalid data file');
        }
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    function importPools(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const pools = JSON.parse(e.target.result);
          if (pools.namePool) data.namePool = pools.namePool;
          if (pools.townPool) data.townPool = pools.townPool;
          if (pools.areaPool) data.areaPool = pools.areaPool;
          if (pools.hookPool) data.hookPool = pools.hookPool;
          data = ensureDataShape(data);
          saveToStorage();
          alert('Pools imported successfully!');
          populateNPCSelect();
          renderNPCList();
          filterNPCs();
        } catch (error) {
          alert('Invalid pools file');
        }
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    // Streamer View Functions
    function openStreamerView() {
      const url = window.location.href.split('?')[0] + '?streamer=true';
      window.open(url, 'StreamerView', 'width=1000,height=800');
    }

    window.addEventListener('storage', (e) => {
      if (e.key === 'daggerheartData') {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('streamer') === 'true') {
          loadFromStorage();
          renderSessionView();
        }
      }
    });

    function checkStreamerView() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('streamer') === 'true') {
        document.body.innerHTML = `
          <div class="streamer-view">
            <div style="max-width: 1600px; margin: 0 auto;">
              <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.3rem; margin-bottom: 1.3rem;">
                <div class="fear-tracker">
                  <h2>Fear</h2>
                  <div style="text-align: center; font-size: 1.6rem; font-weight: bold; margin-bottom: 0.75rem; color: #dc2626;">
                    <span id="fear-counter">0</span> / 12
                  </div>
                  <div id="fear-display" class="fear-tokens"></div>
                </div>
                <div class="countdown-section">
                  <h2 style="text-align: center;">Countdowns</h2>
                  <div id="countdowns-list"></div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.3rem;">
                <div class="spotlight-section">
                  <h2 style="text-align: center;">Player Spotlight</h2>
                  <div id="spotlight-list" class="spotlight-grid"></div>
                </div>
                <div class="combat-zones-section">
                  <h2 style="text-align: center;">Combat Zones</h2>
                  <div id="combat-zones-container" class="combat-zones-container"></div>
                  <div class="unassigned-tokens" style="margin-top: 1rem;">
                    <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 0.75rem; text-align: center;">Unassigned</h3>
                    <div id="unassigned-tokens" class="zone-tokens-container"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        let lastFearAction = null;
        
        setInterval(() => {
          loadFromStorage();
          renderSessionView();
          
          const fearActionStr = localStorage.getItem('fearAction');
          if (fearActionStr) {
            const fearAction = JSON.parse(fearActionStr);
            if (fearAction.type === 'spend' && (!lastFearAction || lastFearAction.timestamp !== fearAction.timestamp)) {
              lastFearAction = fearAction;
              showFearSpendFlash();
            }
          }
        }, 500);
      }
    }
    
    function showFearSpendFlash() {
      const flash = document.createElement('div');
      flash.className = 'fear-spend-flash';
      flash.innerHTML = '<div class="fear-spend-text">GM USES A FEAR!</div>';
      document.body.appendChild(flash);
      
      setTimeout(() => {
        document.body.removeChild(flash);
      }, 1200);
    }

    // Token type selector handler
    document.addEventListener('DOMContentLoaded', () => {
      const typeSelect = document.getElementById('token-type');
      const nameInput = document.getElementById('token-name');
      const npcSelect = document.getElementById('token-npc-select');
      
      if (typeSelect && nameInput && npcSelect) {
        typeSelect.addEventListener('change', (e) => {
          if (e.target.value === 'npc') {
            nameInput.classList.add('hidden');
            npcSelect.classList.remove('hidden');
          } else {
            nameInput.classList.remove('hidden');
            npcSelect.classList.add('hidden');
          }
        });
      }
    });

    // Initialize
    loadFromStorage();
    saveToStorage();
    switchTab('characters');
    checkStreamerView();
    renderPCs();
    renderNPCList();
    filterNPCs();
    renderTownList();
    renderAreaList();
    renderHookList();
    renderLootList();
  </script>
</body>
</html>