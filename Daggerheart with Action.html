<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daggerheart Campaign Manager</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #111827; color: #f3f4f6; font-family: system-ui, -apple-system, sans-serif; padding: 1.5rem; }
    .container { max-width: 1280px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    h1 { color: #dc2626; font-size: 2.25rem; }
    .btn-group { display: flex; gap: 0.5rem; }
    button, .btn-label { padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; cursor: pointer; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s; }
    .btn-primary { background: #dc2626; color: white; }
    .btn-primary:hover { background: #b91c1c; }
    .btn-green { background: #16a34a; color: white; }
    .btn-green:hover { background: #15803d; }
    .btn-blue { background: #2563eb; color: white; }
    .btn-blue:hover { background: #1d4ed8; }
    .btn-purple { background: #9333ea; color: white; }
    .btn-purple:hover { background: #7e22ce; }
    .btn-gray { background: #4b5563; color: white; }
    .btn-gray:hover { background: #374151; }
    .btn-yellow { background: #ca8a04; color: white; }
    .btn-yellow:hover { background: #a16207; }
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; overflow-x: auto; }
    .tab { padding: 0.75rem 1.5rem; border-radius: 0.375rem 0.375rem 0 0; border: none; cursor: pointer; background: #1f2937; color: #9ca3af; white-space: nowrap; }
    .tab.active { background: #dc2626; color: white; }
    .tab:hover:not(.active) { background: #374151; }
    .tab-session { background: #0f172a; border: 2px solid #1e40af; font-weight: bold; }
    .tab-session.active { background: #1e40af; color: #fbbf24; }
    .tab-session:hover:not(.active) { background: #1e293b; }
    .content { background: #1f2937; border-radius: 0.5rem; padding: 1.5rem; }
    .card { background: #374151; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .card-title { font-weight: bold; font-size: 1.125rem; }
    .card-content { color: #d1d5db; }
    .search-box { position: relative; flex: 1; max-width: 300px; }
    .search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; }
    .search-box input { width: 100%; padding: 0.5rem 0.5rem 0.5rem 2.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; }
    .filters { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
    .checkbox-label input[type="checkbox"] { width: 1rem; height: 1rem; cursor: pointer; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .status-alive { background: #16a34a; color: white; }
    .status-dead { background: #dc2626; color: white; }
    .status-unknown { background: #6b7280; color: white; }
    .status-met { background: #3b82f6; color: white; }
    .status-unmet { background: #9ca3af; color: white; }
    .star { color: #fbbf24; cursor: pointer; font-size: 1.25rem; }
    .star.inactive { color: #4b5563; }
    .delete-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; color: #f87171; background: transparent; }
    .delete-btn:hover { color: #dc2626; }
    .loot-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem; }
    .loot-tier-card { background: #374151; padding: 0.75rem; border-radius: 0.375rem; }
    .loot-tier-title { font-weight: bold; margin-bottom: 0.5rem; font-size: 0.875rem; }
    .loot-buttons { display: flex; flex-direction: column; gap: 0.5rem; }
    .hidden { display: none; }
    input[type="file"] { display: none; }
    .empty-state { color: #6b7280; font-size: 0.875rem; }
    .generation-card { background: #374151; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
    svg { width: 1.125rem; height: 1.125rem; }
    
    /* Session View */
    .session-container { display: grid; gap: 1.5rem; max-width: 1400px; margin: 0 auto; }
    .fear-tracker { background: #1f2937; padding: 1rem; border-radius: 0.5rem; text-align: center; }
    .fear-tokens { display: flex; justify-content: center; gap: 0.375rem; margin: 0.75rem 0; flex-wrap: wrap; }
    .fear-token { width: 30px; height: 30px; background: linear-gradient(135deg, #dc2626, #991b1b); border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.2); transition: all 0.4s ease; position: relative; }
    .fear-token.empty { background: #374151; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
    .fear-token.spending { animation: spendFear 0.6s ease; }
    .fear-token.gaining { animation: gainFear 0.5s ease; }
    @keyframes spendFear { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.8; background: #fbbf24; } 100% { transform: scale(0.8); opacity: 1; } }
    @keyframes gainFear { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.15); } 100% { transform: scale(1); opacity: 1; } }
    .fear-controls { display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.75rem; }
    .fear-spend-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(220, 38, 38, 0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; animation: flashFear 1.2s ease-out; pointer-events: none; }
    .fear-spend-text { font-size: 5rem; font-weight: bold; color: white; text-shadow: 0 0 30px rgba(0,0,0,0.8); animation: fearTextPulse 1.2s ease-out; }
    @keyframes flashFear { 0% { opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
    @keyframes fearTextPulse { 0% { transform: scale(0.5); opacity: 0; } 30% { transform: scale(1.2); opacity: 1; } 70% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.8); opacity: 0; } }
    
    .countdown-section { background: #1f2937; padding: 2rem; border-radius: 0.5rem; }
    .countdown-item { background: #374151; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem; }
    .countdown-item.at-zero { border: 2px solid #fbbf24; }
    .countdown-display { display: flex; justify-content: center; gap: 0.5rem; margin: 1rem 0; flex-wrap: wrap; }
    .countdown-pip { width: 30px; height: 30px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: all 0.3s ease; }
    .countdown-pip.empty { background: #1f2937; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5); }
    .countdown-pip.decreasing { animation: decreaseCountdown 0.4s ease; }
    .countdown-pip.increasing { animation: increaseCountdown 0.4s ease; }
    @keyframes decreaseCountdown { 0% { transform: scale(1); } 50% { transform: scale(0.7); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes increaseCountdown { 0% { transform: scale(0.8); opacity: 0; } 60% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
    .countdown-controls { display: flex; gap: 0.5rem; align-items: center; justify-content: center; margin-top: 1rem; }
    .add-countdown-form { background: #374151; padding: 0.75rem; border-radius: 0.5rem; display: flex; gap: 0.75rem; align-items: end; flex-wrap: wrap; margin-bottom: 1rem; }
    .form-field { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-field label { font-size: 0.875rem; color: #9ca3af; }
    .form-field input, .form-field select { padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; }
    
    .spotlight-section { background: #1f2937; padding: 1.5rem; border-radius: 0.5rem; }
    .spotlight-controls { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .spotlight-grid { display: grid; gap: 1rem; }
    .spotlight-player { background: #374151; padding: 1rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
    .spotlight-info { flex: 1; }
    .spotlight-name { font-weight: bold; font-size: 1rem; margin-bottom: 0.5rem; }
    .spotlight-pips { display: flex; gap: 0.25rem; }
    .spotlight-pip { width: 20px; height: 20px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: all 0.3s ease; }
    .spotlight-pip.empty { background: #1f2937; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5); }
    
    /* Combat Zones */
    .combat-zones-section { background: #1f2937; padding: 1.5rem; border-radius: 0.5rem; }
    .combat-zones-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .combat-zone { background: #374151; padding: 1rem; border-radius: 0.5rem; border: 2px solid #4b5563; min-height: 150px; }
    .combat-zone-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #4b5563; }
    .combat-zone-name { font-weight: bold; font-size: 1rem; color: #fbbf24; cursor: text; flex: 1; padding: 0.25rem; background: transparent; border: none; }
    .combat-zone-name:hover { background: #1f2937; border-radius: 0.25rem; }
    .zone-tokens-container { display: flex; flex-direction: column; gap: 0.5rem; min-height: 80px; }
    .zone-token { background: #1f2937; padding: 0.5rem; border-radius: 0.375rem; cursor: move; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: all 0.2s; }
    .zone-token:hover { background: #111827; border-color: #3b82f6; }
    .zone-token.dragging { opacity: 0.5; }
    .zone-token.pc-token { border-left: 3px solid #16a34a; }
    .zone-token.adversary-token { border-left: 3px solid #dc2626; }
    .zone-token.custom-token { border-left: 3px solid #9333ea; }
    .zone-token.npc-token { border-left: 3px solid #3b82f6; }
    .token-name { font-size: 0.875rem; font-weight: 500; }
    .combat-zone.drag-over { background: #1f2937; border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
    .zone-controls { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
    .unassigned-tokens { background: #374151; padding: 1rem; border-radius: 0.5rem; border: 2px dashed #4b5563; margin-top: 1rem; }
    .add-token-form { background: #374151; padding: 0.75rem; border-radius: 0.5rem; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem; }
    
    /* Streamer View */
    .streamer-view { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); min-height: 100vh; padding: 3rem; }
    .streamer-view .fear-tracker, .streamer-view .countdown-section, .streamer-view .spotlight-section, .streamer-view .combat-zones-section { background: rgba(31, 41, 55, 0.6); border: 3px solid #3b82f6; box-shadow: 0 0 40px rgba(59, 130, 246, 0.3); backdrop-filter: blur(10px); }
    .streamer-view .fear-token, .streamer-view .countdown-pip { width: 70px; height: 70px; }
    .streamer-view h2 { font-size: 3rem; margin-bottom: 2rem; text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
    .streamer-view h3 { font-size: 2rem; text-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
    .streamer-view .countdown-controls, .streamer-view .spotlight-controls, .streamer-view .zone-controls, .streamer-view .add-token-form, .streamer-view .delete-btn { display: none; }
    .streamer-view .countdown-item { background: #374151; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 2px solid rgba(59, 130, 246, 0.3); }
    .streamer-view .countdown-item.at-zero { border: 2px solid #fbbf24; box-shadow: 0 0 30px rgba(251, 191, 36, 0.8); }
    .streamer-view .spotlight-pip { width: 40px; height: 40px; }
    .streamer-view .zone-token { cursor: default; }
    .streamer-view .countdown-item.warning-high { animation: streamerPulseSlowWarning 3.6s ease-in-out infinite; }
    .streamer-view .countdown-item.warning-medium { animation: streamerPulseMediumWarning 2.4s ease-in-out infinite; }
    .streamer-view .countdown-item.warning-critical { animation: streamerPulseFastWarning 1.2s ease-in-out infinite; }
    @keyframes streamerPulseSlowWarning { 0%, 100% { box-shadow: 0 0 0 rgba(251, 191, 36, 0); } 50% { box-shadow: 0 0 30px rgba(251, 191, 36, 0.8); } }
    @keyframes streamerPulseMediumWarning { 0%, 100% { box-shadow: 0 0 0 rgba(249, 115, 22, 0); } 50% { box-shadow: 0 0 35px rgba(249, 115, 22, 0.9); } }
    @keyframes streamerPulseFastWarning { 0%, 100% { box-shadow: 0 0 0 rgba(220, 38, 38, 0); } 50% { box-shadow: 0 0 40px rgba(220, 38, 38, 1); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üó°Ô∏è Daggerheart Campaign Manager</h1>
      <div class="btn-group">
        <button class="btn-primary" onclick="exportData()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
          Export Data
        </button>
        <label class="btn-primary btn-label">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
          Import Data
          <input type="file" accept=".json" onchange="importData(event)">
        </label>
        <label class="btn-purple btn-label">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
          Import Pools
          <input type="file" accept=".json" onchange="importPools(event)">
        </label>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('characters')">Characters</button>
      <button class="tab" onclick="switchTab('towns')">Towns</button>
      <button class="tab" onclick="switchTab('areas')">Areas</button>
      <button class="tab" onclick="switchTab('plotHooks')">Plot Hooks</button>
      <button class="tab" onclick="switchTab('loot')">Loot</button>
      <div style="flex: 1; min-width: 20px;"></div>
      <button class="tab tab-session" onclick="switchTab('session')">‚ö° Session View</button>
    </div>

    <div class="content">
      <div id="characters-tab">
        <div style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #374151;">
          <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Player Characters</h2>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <input type="text" id="pc-name" placeholder="PC Name" style="flex: 1; min-width: 200px; padding: 0.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            <select id="pc-class" style="padding: 0.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-width: 150px;">
              <option value="">Select Class</option>
              <option value="Guardian">Guardian</option>
              <option value="Ranger">Ranger</option>
              <option value="Seraph">Seraph</option>
              <option value="Warrior">Warrior</option>
              <option value="Bard">Bard</option>
              <option value="Druid">Druid</option>
              <option value="Rogue">Rogue</option>
              <option value="Sorcerer">Sorcerer</option>
              <option value="Wizard">Wizard</option>
            </select>
            <button class="btn-green" onclick="addPC()">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              Add PC
            </button>
          </div>
          <div id="pc-list" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
        </div>

        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">NPCs</h2>
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <button class="btn-primary" onclick="generateNPC()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Generate NPC
          </button>
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" id="npc-search" placeholder="Search NPCs..." oninput="filterNPCs()">
          </div>
        </div>

        <div class="filters">
          <label class="checkbox-label">
            <input type="checkbox" id="filter-met" onchange="filterNPCs()">
            <span>Met Only</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="filter-unmet" onchange="filterNPCs()">
            <span>Unmet Only</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="filter-alive" onchange="filterNPCs()">
            <span>Alive/Unknown Only</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="filter-starred" onchange="filterNPCs()">
            <span>Starred Only</span>
          </label>
        </div>

        <div id="npc-generation"></div>
        <div id="npc-list"></div>
      </div>

      <div id="towns-tab" class="hidden">
        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Towns & Settlements</h2>
        <button class="btn-primary" onclick="generateTown()" style="margin-bottom: 1rem;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Generate Town
        </button>
        <div id="town-generation"></div>
        <div id="town-list"></div>
      </div>

      <div id="areas-tab" class="hidden">
        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Areas & Locations</h2>
        <button class="btn-primary" onclick="generateArea()" style="margin-bottom: 1rem;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Generate Area
        </button>
        <div id="area-generation"></div>
        <div id="area-list"></div>
      </div>

      <div id="plotHooks-tab" class="hidden">
        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Plot Hooks & Quests</h2>
        <button class="btn-primary" onclick="generateHook()" style="margin-bottom: 1rem;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Generate Plot Hook
        </button>
        <div id="hook-generation"></div>
        <div id="hook-list"></div>
      </div>

      <div id="loot-tab" class="hidden">
        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Loot Generator</h2>
        <div class="loot-grid">
          <div class="loot-tier-card">
            <div class="loot-tier-title">Minor Loot</div>
            <div class="loot-buttons">
              <button class="btn-gray" onclick="generateLoot('minor')">Generate Minor</button>
            </div>
          </div>
          <div class="loot-tier-card">
            <div class="loot-tier-title">Major Loot</div>
            <div class="loot-buttons">
              <button class="btn-blue" onclick="generateLoot('major')">Generate Major</button>
            </div>
          </div>
          <div class="loot-tier-card">
            <div class="loot-tier-title">Superior Loot</div>
            <div class="loot-buttons">
              <button class="btn-purple" onclick="generateLoot('superior')">Generate Superior</button>
            </div>
          </div>
        </div>
        <div id="loot-generation"></div>
        <div id="loot-list"></div>
      </div>

      <div id="session-tab" class="hidden">
        <div style="margin-bottom: 1.5rem;">
          <button class="btn-blue" onclick="openStreamerView()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            Open Streamer View
          </button>
        </div>

        <div class="session-container">
         <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div class="fear-tracker">
              <h2 style="font-size: 2rem; font-weight: bold; margin-bottom: 1rem;">Fear</h2>
              <div style="text-align: center; font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem; color: #dc2626;">
                <span id="fear-counter">0</span> / 12
              </div>
              <div id="fear-display" class="fear-tokens"></div>
              <div class="fear-controls">
                <button class="btn-primary" onclick="modifyFear(-1)">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
                  Spend Fear
                </button>
                <button class="btn-primary" onclick="modifyFear(1)">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                  Add Fear
                </button>
              </div>
            </div>

            <div class="countdown-section" style="padding: 1.5rem;">
              <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; text-align: center;">Countdowns</h2>
              
              <div class="add-countdown-form">
                <div class="form-field" style="flex: 2; min-width: 150px;">
                  <label>Name</label>
                  <input type="text" id="countdown-name" placeholder="Countdown name">
                </div>
                <div class="form-field" style="flex: 1; min-width: 100px;">
                  <label>Max</label>
                  <select id="countdown-max">
                    <option value="4">d4</option>
                    <option value="6" selected>d6</option>
                    <option value="8">d8</option>
                    <option value="10">d10</option>
                    <option value="12">d12</option>
                  </select>
                </div>
                <button class="btn-green" onclick="addCountdown()" style="align-self: flex-end;">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                  Add
                </button>
              </div>
              
              <div id="countdowns-list"></div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div class="spotlight-section">
              <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; text-align: center;">Spotlight</h2>
              <div class="spotlight-controls">
                <select id="spotlight-pc-select" style="flex: 1; padding: 0.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
                  <option value="">Select PC</option>
                </select>
                <button class="btn-green" onclick="addSpotlightPlayer()">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                  Add
                </button>
              </div>
              <div id="spotlight-list" class="spotlight-grid"></div>
            </div>

            <div class="combat-zones-section">
              <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Combat Zones</h2>
              <div class="zone-controls">
                <button class="btn-green" onclick="addCombatZone()">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                  Add Zone
                </button>
              </div>
              <div id="combat-zones-container" class="combat-zones-container"></div>
              
              <div class="unassigned-tokens">
                <h3 style="font-size: 1rem; font-weight: bold; margin-bottom: 0.75rem;">Unassigned Tokens</h3>
                <div class="add-token-form">
                  <select id="token-type" style="padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
                    <option value="adversary">Adversary</option>
                    <option value="custom">Custom</option>
                    <option value="npc">Saved NPC</option>
                  </select>
                  <input type="text" id="token-name" placeholder="Token name" style="flex: 1; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-width: 150px;">
                  <select id="token-npc-select" class="hidden" style="flex: 1; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-width: 150px;">
                    <option value="">Select NPC</option>
                  </select>
                  <button class="btn-green" onclick="addCombatToken()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Token
                  </button>
                </div>
                <div id="unassigned-tokens" class="zone-tokens-container"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


<script>
    // Data structure
    let data = {
      pcs: [],
      npcs: [],
      towns: [],
      areas: [],
      plotHooks: [],
      loot: [],
      sessionState: {
        fear: 0,
        countdowns: [],
        spotlightPlayers: [],
        combatZones: [],
        combatTokens: []
      },
      namePool: { first: [], last: [] },
      townPool: [],
      areaPool: [],
      hookPool: []
    };

    let currentGeneration = null;

    // Storage functions
    function saveToStorage() {
      localStorage.setItem('daggerheartData', JSON.stringify(data));
    }

    function loadFromStorage() {
      const saved = localStorage.getItem('daggerheartData');
      if (saved) {
        data = JSON.parse(saved);
      }
    }

    // Tab switching
    function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('[id$="-tab"]').forEach(t => t.classList.add('hidden'));
  
  // Find the tab button that was clicked
  const tabButton = Array.from(document.querySelectorAll('.tab')).find(
    tab => tab.textContent.toLowerCase().includes(tabName) || 
           tab.getAttribute('onclick')?.includes(`'${tabName}'`)
  );
  if (tabButton) {
    tabButton.classList.add('active');
  }
  
  document.getElementById(`${tabName}-tab`).classList.remove('hidden');
  
  if (tabName === 'session') {
    renderSessionView();
  }
}

    // PC Functions
    function addPC() {
      const name = document.getElementById('pc-name').value.trim();
      const pcClass = document.getElementById('pc-class').value;
      
      if (!name || !pcClass) {
        alert('Please enter both name and class');
        return;
      }
      
      data.pcs.push({
        id: Date.now(),
        name,
        class: pcClass
      });
      
      saveToStorage();
      renderPCs();
      
      document.getElementById('pc-name').value = '';
      document.getElementById('pc-class').value = '';
    }

    function deletePC(id) {
      if (confirm('Delete this PC?')) {
        data.pcs = data.pcs.filter(pc => pc.id !== id);
        saveToStorage();
        renderPCs();
      }
    }

    function renderPCs() {
      const container = document.getElementById('pc-list');
      if (data.pcs.length === 0) {
        container.innerHTML = '<p class="empty-state">No PCs added yet</p>';
        return;
      }
      
      container.innerHTML = data.pcs.map(pc => `
        <div style="background: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; display: flex; gap: 0.5rem; align-items: center;">
          <span style="font-weight: 500;">${pc.name}</span>
          <span style="color: #9ca3af; font-size: 0.875rem;">(${pc.class})</span>
          <button class="delete-btn" onclick="deletePC(${pc.id})">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      `).join('');
    }

    // NPC Functions
    function generateNPC() {
      const first = data.namePool.first.length > 0 
        ? data.namePool.first[Math.floor(Math.random() * data.namePool.first.length)]
        : 'Generated';
      const last = data.namePool.last.length > 0
        ? data.namePool.last[Math.floor(Math.random() * data.namePool.last.length)]
        : 'NPC';
      
      currentGeneration = {
        type: 'npc',
        data: {
          id: Date.now(),
          name: `${first} ${last}`,
          role: 'Unknown Role',
          description: 'A mysterious individual...',
          status: 'Unknown',
          met: false,
          starred: false
        }
      };
      
      renderNPCGeneration();
    }

    function renderNPCGeneration() {
      const container = document.getElementById('npc-generation');
      
      if (!currentGeneration || currentGeneration.type !== 'npc') {
        container.innerHTML = '';
        return;
      }
      
      const npc = currentGeneration.data;
      
      container.innerHTML = `
        <div class="generation-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: bold;">Generated NPC</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-green" onclick="saveNPC()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Save
              </button>
              <button class="btn-gray" onclick="clearGeneration()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                Discard
              </button>
            </div>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Name</label>
              <input type="text" value="${npc.name}" onchange="currentGeneration.data.name = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Role</label>
              <input type="text" value="${npc.role}" onchange="currentGeneration.data.role = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Description</label>
              <textarea onchange="currentGeneration.data.description = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-height: 100px;">${npc.description}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function saveNPC() {
      if (currentGeneration && currentGeneration.type === 'npc') {
        data.npcs.push(currentGeneration.data);
        saveToStorage();
        currentGeneration = null;
        renderNPCGeneration();
        renderNPCList();
        filterNPCs();
      }
    }

    function toggleNPCStatus(id, field) {
      const npc = data.npcs.find(n => n.id === id);
      if (!npc) return;
      
      if (field === 'met') {
        npc.met = !npc.met;
      } else if (field === 'starred') {
        npc.starred = !npc.starred;
      } else if (field === 'status') {
        const statuses = ['Alive', 'Dead', 'Unknown'];
        const currentIndex = statuses.indexOf(npc.status);
        npc.status = statuses[(currentIndex + 1) % statuses.length];
      }
      
      saveToStorage();
      filterNPCs();
    }

    function deleteNPC(id) {
      if (confirm('Delete this NPC?')) {
        data.npcs = data.npcs.filter(n => n.id !== id);
        saveToStorage();
        filterNPCs();
      }
    }

    function renderNPCList() {
      const container = document.getElementById('npc-list');
      if (data.npcs.length === 0) {
        container.innerHTML = '<p class="empty-state">No NPCs yet. Generate some!</p>';
        return;
      }
      
      container.innerHTML = data.npcs.map(npc => `
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">${npc.name}</div>
              <div style="color: #9ca3af; font-size: 0.875rem;">${npc.role}</div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <span class="star ${npc.starred ? '' : 'inactive'}" onclick="toggleNPCStatus(${npc.id}, 'starred')">‚òÖ</span>
              <span class="status-badge status-${npc.status.toLowerCase()}" onclick="toggleNPCStatus(${npc.id}, 'status')" style="cursor: pointer;">${npc.status}</span>
              <span class="status-badge status-${npc.met ? 'met' : 'unmet'}" onclick="toggleNPCStatus(${npc.id}, 'met')" style="cursor: pointer;">${npc.met ? 'Met' : 'Unmet'}</span>
              <button class="delete-btn" onclick="deleteNPC(${npc.id})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>
          </div>
          <div class="card-content">${npc.description}</div>
        </div>
      `).join('');
    }

    function filterNPCs() {
      const searchTerm = document.getElementById('npc-search').value.toLowerCase();
      const filterMet = document.getElementById('filter-met').checked;
      const filterUnmet = document.getElementById('filter-unmet').checked;
      const filterAlive = document.getElementById('filter-alive').checked;
      const filterStarred = document.getElementById('filter-starred').checked;
      
      let filtered = data.npcs.filter(npc => {
        const matchesSearch = npc.name.toLowerCase().includes(searchTerm) || 
                            npc.role.toLowerCase().includes(searchTerm) ||
                            npc.description.toLowerCase().includes(searchTerm);
        
        const matchesMet = !filterMet || npc.met;
        const matchesUnmet = !filterUnmet || !npc.met;
        const matchesAlive = !filterAlive || (npc.status === 'Alive' || npc.status === 'Unknown');
        const matchesStarred = !filterStarred || npc.starred;
        
        return matchesSearch && matchesMet && matchesUnmet && matchesAlive && matchesStarred;
      });
      
      const container = document.getElementById('npc-list');
      if (filtered.length === 0) {
        container.innerHTML = '<p class="empty-state">No NPCs match your filters</p>';
        return;
      }
      
      container.innerHTML = filtered.map(npc => `
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">${npc.name}</div>
              <div style="color: #9ca3af; font-size: 0.875rem;">${npc.role}</div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <span class="star ${npc.starred ? '' : 'inactive'}" onclick="toggleNPCStatus(${npc.id}, 'starred')">‚òÖ</span>
              <span class="status-badge status-${npc.status.toLowerCase()}" onclick="toggleNPCStatus(${npc.id}, 'status')" style="cursor: pointer;">${npc.status}</span>
              <span class="status-badge status-${npc.met ? 'met' : 'unmet'}" onclick="toggleNPCStatus(${npc.id}, 'met')" style="cursor: pointer;">${npc.met ? 'Met' : 'Unmet'}</span>
              <button class="delete-btn" onclick="deleteNPC(${npc.id})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>
          </div>
          <div class="card-content">${npc.description}</div>
        </div>
      `).join('');
    }

    // Town Functions
    function generateTown() {
      const townName = data.townPool.length > 0
        ? data.townPool[Math.floor(Math.random() * data.townPool.length)]
        : 'New Settlement';
      
      currentGeneration = {
        type: 'town',
        data: {
          id: Date.now(),
          name: townName,
          description: 'A settlement in the realm...'
        }
      };
      
      renderTownGeneration();
    }

    function renderTownGeneration() {
      const container = document.getElementById('town-generation');
      
      if (!currentGeneration || currentGeneration.type !== 'town') {
        container.innerHTML = '';
        return;
      }
      
      const town = currentGeneration.data;
      
      container.innerHTML = `
        <div class="generation-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: bold;">Generated Town</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-green" onclick="saveTown()">Save</button>
              <button class="btn-gray" onclick="clearGeneration()">Discard</button>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Name</label>
              <input type="text" value="${town.name}" onchange="currentGeneration.data.name = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Description</label>
              <textarea onchange="currentGeneration.data.description = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-height: 100px;">${town.description}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function saveTown() {
      if (currentGeneration && currentGeneration.type === 'town') {
        data.towns.push(currentGeneration.data);
        saveToStorage();
        currentGeneration = null;
        renderTownGeneration();
        renderTownList();
      }
    }

    function deleteTown(id) {
      if (confirm('Delete this town?')) {
        data.towns = data.towns.filter(t => t.id !== id);
        saveToStorage();
        renderTownList();
      }
    }

    function renderTownList() {
      const container = document.getElementById('town-list');
      if (data.towns.length === 0) {
        container.innerHTML = '<p class="empty-state">No towns yet</p>';
        return;
      }
      
      container.innerHTML = data.towns.map(town => `
        <div class="card">
          <div class="card-header">
            <div class="card-title">${town.name}</div>
            <button class="delete-btn" onclick="deleteTown(${town.id})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
          <div class="card-content">${town.description}</div>
        </div>
      `).join('');
    }

    // Area Functions
    function generateArea() {
      const areaName = data.areaPool.length > 0
        ? data.areaPool[Math.floor(Math.random() * data.areaPool.length)]
        : 'Mysterious Location';
      
      currentGeneration = {
        type: 'area',
        data: {
          id: Date.now(),
          name: areaName,
          description: 'An interesting location...'
        }
      };
      
      renderAreaGeneration();
    }

    function renderAreaGeneration() {
      const container = document.getElementById('area-generation');
      
      if (!currentGeneration || currentGeneration.type !== 'area') {
        container.innerHTML = '';
        return;
      }
      
      const area = currentGeneration.data;
      
      container.innerHTML = `
        <div class="generation-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: bold;">Generated Area</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-green" onclick="saveArea()">Save</button>
              <button class="btn-gray" onclick="clearGeneration()">Discard</button>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Name</label>
              <input type="text" value="${area.name}" onchange="currentGeneration.data.name = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Description</label>
              <textarea onchange="currentGeneration.data.description = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-height: 100px;">${area.description}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function saveArea() {
      if (currentGeneration && currentGeneration.type === 'area') {
        data.areas.push(currentGeneration.data);
        saveToStorage();
        currentGeneration = null;
        renderAreaGeneration();
        renderAreaList();
      }
    }

    function deleteArea(id) {
      if (confirm('Delete this area?')) {
        data.areas = data.areas.filter(a => a.id !== id);
        saveToStorage();
        renderAreaList();
      }
    }

    function renderAreaList() {
      const container = document.getElementById('area-list');
      if (data.areas.length === 0) {
        container.innerHTML = '<p class="empty-state">No areas yet</p>';
        return;
      }
      
      container.innerHTML = data.areas.map(area => `
        <div class="card">
          <div class="card-header">
            <div class="card-title">${area.name}</div>
            <button class="delete-btn" onclick="deleteArea(${area.id})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
          <div class="card-content">${area.description}</div>
        </div>
      `).join('');
    }
// Plot Hook Functions
    function generateHook() {
      const hookText = data.hookPool.length > 0
        ? data.hookPool[Math.floor(Math.random() * data.hookPool.length)]
        : 'A mysterious quest appears...';
      
      currentGeneration = {
        type: 'hook',
        data: {
          id: Date.now(),
          title: 'New Plot Hook',
          description: hookText
        }
      };
      
      renderHookGeneration();
    }

    function renderHookGeneration() {
      const container = document.getElementById('hook-generation');
      
      if (!currentGeneration || currentGeneration.type !== 'hook') {
        container.innerHTML = '';
        return;
      }
      
      const hook = currentGeneration.data;
      
      container.innerHTML = `
        <div class="generation-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: bold;">Generated Plot Hook</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-green" onclick="saveHook()">Save</button>
              <button class="btn-gray" onclick="clearGeneration()">Discard</button>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Title</label>
              <input type="text" value="${hook.title}" onchange="currentGeneration.data.title = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Description</label>
              <textarea onchange="currentGeneration.data.description = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-height: 100px;">${hook.description}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function saveHook() {
      if (currentGeneration && currentGeneration.type === 'hook') {
        data.plotHooks.push(currentGeneration.data);
        saveToStorage();
        currentGeneration = null;
        renderHookGeneration();
        renderHookList();
      }
    }

    function deleteHook(id) {
      if (confirm('Delete this plot hook?')) {
        data.plotHooks = data.plotHooks.filter(h => h.id !== id);
        saveToStorage();
        renderHookList();
      }
    }

    function renderHookList() {
      const container = document.getElementById('hook-list');
      if (data.plotHooks.length === 0) {
        container.innerHTML = '<p class="empty-state">No plot hooks yet</p>';
        return;
      }
      
      container.innerHTML = data.plotHooks.map(hook => `
        <div class="card">
          <div class="card-header">
            <div class="card-title">${hook.title}</div>
            <button class="delete-btn" onclick="deleteHook(${hook.id})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
          <div class="card-content">${hook.description}</div>
        </div>
      `).join('');
    }

    // Loot Functions
    function generateLoot(tier) {
      currentGeneration = {
        type: 'loot',
        data: {
          id: Date.now(),
          name: `${tier.charAt(0).toUpperCase() + tier.slice(1)} Item`,
          effect: 'Magical effect...',
          tier
        }
      };
      
      renderLootGeneration();
    }

    function renderLootGeneration() {
      const container = document.getElementById('loot-generation');
      
      if (!currentGeneration || currentGeneration.type !== 'loot') {
        container.innerHTML = '';
        return;
      }
      
      const loot = currentGeneration.data;
      
      container.innerHTML = `
        <div class="generation-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: bold;">Generated ${loot.tier} Loot</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-green" onclick="saveLoot()">Save</button>
              <button class="btn-gray" onclick="clearGeneration()">Discard</button>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Name</label>
              <input type="text" value="${loot.name}" onchange="currentGeneration.data.name = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6;">
            </div>
            <div>
              <label style="display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Effect</label>
              <textarea onchange="currentGeneration.data.effect = this.value" style="width: 100%; padding: 0.5rem; background: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; color: #f3f4f6; min-height: 100px;">${loot.effect}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function saveLoot() {
      if (currentGeneration && currentGeneration.type === 'loot') {
        data.loot.push(currentGeneration.data);
        saveToStorage();
        currentGeneration = null;
        renderLootGeneration();
        renderLootList();
      }
    }

    function deleteLoot(id) {
      if (confirm('Delete this loot?')) {
        data.loot = data.loot.filter(l => l.id !== id);
        saveToStorage();
        renderLootList();
      }
    }

    function renderLootList() {
      const container = document.getElementById('loot-list');
      if (data.loot.length === 0) {
        container.innerHTML = '<p class="empty-state">No saved loot yet</p>';
        return;
      }
      
      container.innerHTML = data.loot.map(loot => `
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">${loot.name}</div>
              <span class="status-badge" style="background: #9333ea; color: white;">${loot.tier}</span>
            </div>
            <button class="delete-btn" onclick="deleteLoot(${loot.id})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
          <div class="card-content">${loot.effect}</div>
        </div>
      `).join('');
    }

    function clearGeneration() {
      currentGeneration = null;
      renderNPCGeneration();
      renderTownGeneration();
      renderAreaGeneration();
      renderHookGeneration();
      renderLootGeneration();
    }

    // Session View Functions
    function renderSessionView() {
      renderFearTracker();
      renderCountdowns();
      renderSpotlightTracker();
      renderCombatZones();
      populateSpotlightSelect();
      populateNPCSelect();
    }

    function renderFearTracker() {
      const container = document.getElementById('fear-display');
      const counter = document.getElementById('fear-counter');
      const fear = data.sessionState.fear;
      
      if (counter) {
        counter.textContent = fear;
      }
      
      let html = '';
      
      for (let i = 0; i < 12; i++) {
        const filled = i < fear;
        html += `<div class="fear-token ${filled ? '' : 'empty'}"></div>`;
      }
      
      container.innerHTML = html;
    }

    function modifyFear(delta) {
      const newFear = Math.max(0, Math.min(12, data.sessionState.fear + delta));
      if (newFear === data.sessionState.fear) return;
      
      data.sessionState.fear = newFear;
      
      if (delta < 0) {
        localStorage.setItem('fearAction', JSON.stringify({
          type: 'spend',
          timestamp: Date.now()
        }));
      }
      
      saveToStorage();
      
      const container = document.getElementById('fear-display');
      if (!container) return;
      const tokens = container.querySelectorAll('.fear-token');
      
      if (delta < 0) {
        const tokenIndex = newFear;
        if (tokens[tokenIndex]) {
          tokens[tokenIndex].classList.add('spending');
          setTimeout(() => {
            renderFearTracker();
          }, 600);
        }
      } else {
        renderFearTracker();
        const tokenIndex = newFear - 1;
        const newTokens = container.querySelectorAll('.fear-token');
        if (newTokens[tokenIndex]) {
          newTokens[tokenIndex].classList.add('gaining');
        }
      }
    }

    function addCountdown() {
      const name = document.getElementById('countdown-name').value.trim();
      const max = parseInt(document.getElementById('countdown-max').value);
      
      if (!name) {
        alert('Please enter a countdown name');
        return;
      }
      
      data.sessionState.countdowns.push({
        id: Date.now(),
        name,
        current: max,
        max
      });
      
      saveToStorage();
      renderCountdowns();
      
      document.getElementById('countdown-name').value = '';
    }

    function modifyCountdown(id, delta) {
      const countdown = data.sessionState.countdowns.find(c => c.id === id);
      if (!countdown) return;
      
      const newValue = Math.max(0, Math.min(countdown.max, countdown.current + delta));
      if (newValue === countdown.current) return;
      
      const oldValue = countdown.current;
      countdown.current = newValue;
      saveToStorage();
      
      setTimeout(() => {
        renderCountdowns();
        const item = document.querySelector(`[data-countdown-id="${id}"]`);
        if (!item) return;
        
        const pips = item.querySelectorAll('.countdown-pip');
        if (delta < 0) {
          const pipIndex = newValue;
          if (pips[pipIndex]) {
            pips[pipIndex].classList.add('decreasing');
          }
        } else {
          const pipIndex = newValue - 1;
          if (pips[pipIndex]) {
            pips[pipIndex].classList.add('increasing');
          }
        }
        
        if (newValue === 0 && oldValue !== 0) {
          item.classList.add('at-zero');
        }
      }, 50);
    }

    function deleteCountdown(id) {
      if (confirm('Delete this countdown?')) {
        data.sessionState.countdowns = data.sessionState.countdowns.filter(c => c.id !== id);
        saveToStorage();
        renderCountdowns();
      }
    }

    function renderCountdowns() {
      const container = document.getElementById('countdowns-list');
      if (!container) return;
      
      if (data.sessionState.countdowns.length === 0) {
        container.innerHTML = '<p class="empty-state" style="text-align: center;">No countdowns active.</p>';
        return;
      }
      
      container.innerHTML = data.sessionState.countdowns.map(countdown => {
        const percentage = (countdown.current / countdown.max) * 100;
        let warningClass = '';
        
        if (countdown.current === 0) {
          warningClass = 'at-zero';
        } else if (percentage <= 25) {
          warningClass = 'warning-critical';
        } else if (percentage <= 50) {
          warningClass = 'warning-medium';
        } else if (percentage <= 75) {
          warningClass = 'warning-high';
        }
        
        return `
          <div class="countdown-item ${warningClass}" data-countdown-id="${countdown.id}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <h3 style="font-weight: bold; font-size: 1.125rem;">${countdown.name}</h3>
              <button class="delete-btn" onclick="deleteCountdown(${countdown.id})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="countdown-display">
              ${Array.from({length: countdown.max}, (_, i) => 
                `<div class="countdown-pip ${i < countdown.current ? '' : 'empty'}"></div>`
              ).join('')}
            </div>
            <div class="countdown-controls">
              <button class="btn-primary" onclick="modifyCountdown(${countdown.id}, -1)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
              </button>
              <span style="font-weight: bold; font-size: 1.25rem;">${countdown.current} / ${countdown.max}</span>
              <button class="btn-primary" onclick="modifyCountdown(${countdown.id}, 1)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function populateSpotlightSelect() {
      const select = document.getElementById('spotlight-pc-select');
      if (!select) return;
      
      const alreadyInSpotlight = data.sessionState.spotlightPlayers.map(p => p.pcId);
      const availablePCs = data.pcs.filter(pc => !alreadyInSpotlight.includes(pc.id));
      
      select.innerHTML = '<option value="">Select PC</option>' +
        availablePCs.map(pc => `<option value="${pc.id}">${pc.name}</option>`).join('');
    }

    function addSpotlightPlayer() {
      const select = document.getElementById('spotlight-pc-select');
      const pcId = parseInt(select.value);
      
      if (!pcId) {
        alert('Please select a PC');
        return;
      }
      
      const pc = data.pcs.find(p => p.id === pcId);
      if (!pc) return;
      
      data.sessionState.spotlightPlayers.push({
        id: Date.now(),
        pcId: pc.id,
        name: pc.name,
        pips: 0
      });
      
      saveToStorage();
      renderSpotlightTracker();
      populateSpotlightSelect();
    }

    function modifySpotlight(id, delta) {
      const player = data.sessionState.spotlightPlayers.find(p => p.id === id);
      if (!player) return;
      
      player.pips = Math.max(0, Math.min(6, player.pips + delta));
      saveToStorage();
      renderSpotlightTracker();
    }

    function removeSpotlight(id) {
      data.sessionState.spotlightPlayers = data.sessionState.spotlightPlayers.filter(p => p.id !== id);
      saveToStorage();
      renderSpotlightTracker();
      populateSpotlightSelect();
    }

    function renderSpotlightTracker() {
      const container = document.getElementById('spotlight-list');
      if (!container) return;
      
      if (data.sessionState.spotlightPlayers.length === 0) {
        container.innerHTML = '<p class="empty-state" style="grid-column: 1/-1; text-align: center;">No players in spotlight tracker.</p>';
        return;
      }
      
      container.innerHTML = data.sessionState.spotlightPlayers.map(player => `
        <div class="spotlight-player">
          <div class="spotlight-info">
            <div class="spotlight-name">${player.name}</div>
            <div class="spotlight-pips">
              ${Array.from({length: 6}, (_, i) => 
                `<div class="spotlight-pip ${i < player.pips ? '' : 'empty'}"></div>`
              ).join('')}
            </div>
          </div>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button class="btn-gray" onclick="modifySpotlight(${player.id}, -1)">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
            </button>
            <button class="btn-gray" onclick="modifySpotlight(${player.id}, 1)">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            </button>
            <button class="delete-btn" onclick="removeSpotlight(${player.id})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        </div>
      `).join('');
    }
// Combat Zones Functions
    function addCombatZone() {
      if (data.sessionState.combatZones.length >= 5) {
        alert('Maximum of 5 combat zones allowed');
        return;
      }
      
      data.sessionState.combatZones.push({
        id: Date.now(),
        name: `Zone ${data.sessionState.combatZones.length + 1}`,
        tokenIds: []
      });
      
      saveToStorage();
      renderCombatZones();
    }

    function deleteCombatZone(zoneId) {
      if (confirm('Delete this zone? Tokens will be moved to Unassigned.')) {
        const zone = data.sessionState.combatZones.find(z => z.id === zoneId);
        if (zone) {
          zone.tokenIds.forEach(tokenId => {
            const token = data.sessionState.combatTokens.find(t => t.id === tokenId);
            if (token) {
              token.zoneId = null;
            }
          });
        }
        
        data.sessionState.combatZones = data.sessionState.combatZones.filter(z => z.id !== zoneId);
        saveToStorage();
        renderCombatZones();
      }
    }

    function renameCombatZone(zoneId, newName) {
      const zone = data.sessionState.combatZones.find(z => z.id === zoneId);
      if (zone) {
        zone.name = newName || `Zone ${data.sessionState.combatZones.indexOf(zone) + 1}`;
        saveToStorage();
      }
    }

    function addCombatToken() {
      const type = document.getElementById('token-type').value;
      const nameInput = document.getElementById('token-name');
      const npcSelect = document.getElementById('token-npc-select');
      
      let name = '';
      if (type === 'npc') {
        const npcId = parseInt(npcSelect.value);
        if (!npcId) {
          alert('Please select an NPC');
          return;
        }
        const npc = data.npcs.find(n => n.id === npcId);
        name = npc ? npc.name : 'Unknown NPC';
      } else {
        name = nameInput.value.trim();
        if (!name) {
          alert('Please enter a token name');
          return;
        }
      }
      
      data.sessionState.combatTokens.push({
        id: Date.now(),
        name,
        type,
        zoneId: null
      });
      
      saveToStorage();
      renderCombatZones();
      
      nameInput.value = '';
      npcSelect.value = '';
    }

    function deleteCombatToken(tokenId) {
      if (confirm('Delete this token?')) {
        data.sessionState.combatTokens = data.sessionState.combatTokens.filter(t => t.id !== tokenId);
        
        data.sessionState.combatZones.forEach(zone => {
          zone.tokenIds = zone.tokenIds.filter(id => id !== tokenId);
        });
        
        saveToStorage();
        renderCombatZones();
      }
    }

    function handleTokenDragStart(e, tokenId) {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', tokenId);
      e.target.classList.add('dragging');
    }

    function handleTokenDragEnd(e) {
      e.target.classList.remove('dragging');
    }

    function handleZoneDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      e.currentTarget.classList.add('drag-over');
    }

    function handleZoneDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function handleZoneDrop(e, targetZoneId) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      const tokenId = e.dataTransfer.getData('text/plain');
      
      if (tokenId.startsWith('pc-')) {
        const pcId = parseInt(tokenId.replace('pc-', ''));
        const pc = data.pcs.find(p => p.id === pcId);
        if (!pc) return;
        
        let token = data.sessionState.combatTokens.find(t => t.pcId === pcId);
        if (!token) {
          token = {
            id: Date.now(),
            name: pc.name,
            type: 'pc',
            pcId: pcId,
            zoneId: null
          };
          data.sessionState.combatTokens.push(token);
        }
        
        if (token.zoneId) {
          const oldZone = data.sessionState.combatZones.find(z => z.id === token.zoneId);
          if (oldZone) {
            oldZone.tokenIds = oldZone.tokenIds.filter(id => id !== token.id);
          }
        }
        
        token.zoneId = targetZoneId;
        if (targetZoneId) {
          const newZone = data.sessionState.combatZones.find(z => z.id === targetZoneId);
          if (newZone && !newZone.tokenIds.includes(token.id)) {
            newZone.tokenIds.push(token.id);
          }
        }
      } else {
        const numTokenId = parseInt(tokenId);
        const token = data.sessionState.combatTokens.find(t => t.id === numTokenId);
        
        if (!token) return;
        
        if (token.zoneId) {
          const oldZone = data.sessionState.combatZones.find(z => z.id === token.zoneId);
          if (oldZone) {
            oldZone.tokenIds = oldZone.tokenIds.filter(id => id !== numTokenId);
          }
        }
        
        token.zoneId = targetZoneId;
        if (targetZoneId) {
          const newZone = data.sessionState.combatZones.find(z => z.id === targetZoneId);
          if (newZone && !newZone.tokenIds.includes(numTokenId)) {
            newZone.tokenIds.push(numTokenId);
          }
        }
      }
      
      saveToStorage();
      renderCombatZones();
    }

    function renderCombatZones() {
      const container = document.getElementById('combat-zones-container');
      const unassignedContainer = document.getElementById('unassigned-tokens');
      
      if (!container || !unassignedContainer) return;
      
      const zones = data.sessionState.combatZones || [];
      if (zones.length === 0) {
        container.innerHTML = '<p class="empty-state" style="grid-column: 1/-1; text-align: center;">No combat zones. Add one to get started!</p>';
      } else {
        container.innerHTML = zones.map(zone => {
          const tokens = (zone.tokenIds || [])
            .map(tokenId => data.sessionState.combatTokens.find(t => t.id === tokenId))
            .filter(t => t);
          
          return `
            <div class="combat-zone" 
                 ondragover="handleZoneDragOver(event)" 
                 ondragleave="handleZoneDragLeave(event)"
                 ondrop="handleZoneDrop(event, ${zone.id})">
              <div class="combat-zone-header">
                <input 
                  type="text" 
                  class="combat-zone-name" 
                  value="${zone.name}"
                  onblur="renameCombatZone(${zone.id}, this.value)"
                  onkeypress="if(event.key === 'Enter') this.blur()">
                <button class="delete-btn" onclick="deleteCombatZone(${zone.id})">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
              <div class="zone-tokens-container">
                ${tokens.length === 0 ? '<p class="empty-state" style="text-align: center; padding: 1rem; font-size: 0.875rem;">Drop tokens here</p>' : 
                  tokens.map(token => `
                    <div class="zone-token ${token.type}-token" 
                         draggable="true"
                         ondragstart="handleTokenDragStart(event, ${token.id})"
                         ondragend="handleTokenDragEnd(event)">
                      <span class="token-name">${token.name}</span>
                      <button class="delete-btn" onclick="deleteCombatToken(${token.id})">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                      </button>
                    </div>
                  `).join('')
                }
              </div>
            </div>
          `;
        }).join('');
      }
      
      const unassignedTokens = data.sessionState.combatTokens.filter(t => !t.zoneId);
      
      const assignedPcIds = data.sessionState.combatTokens
        .filter(t => t.pcId && t.zoneId)
        .map(t => t.pcId);
      
      const pcTokens = data.pcs
        .filter(pc => !assignedPcIds.includes(pc.id))
        .map(pc => ({
          id: `pc-${pc.id}`,
          name: pc.name,
          type: 'pc',
          isPc: true
        }));
      
      const allUnassigned = [...pcTokens, ...unassignedTokens];
      
      const unassignedHtml = allUnassigned.length === 0 
        ? '<p class="empty-state" style="text-align: center; padding: 1rem; font-size: 0.875rem;">No unassigned tokens</p>'
        : allUnassigned.map(token => `
            <div class="zone-token ${token.type}-token" 
                 draggable="true"
                 ondragstart="handleTokenDragStart(event, ${token.isPc ? `'${token.id}'` : token.id})"
                 ondragend="handleTokenDragEnd(event)">
              <span class="token-name">${token.name}</span>
              ${!token.isPc ? `
                <button class="delete-btn" onclick="deleteCombatToken(${token.id})">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              ` : ''}
            </div>
          `).join('');
      
      unassignedContainer.innerHTML = `
        <div style="padding: 0.5rem;"
             ondragover="handleZoneDragOver(event)" 
             ondragleave="handleZoneDragLeave(event)"
             ondrop="handleZoneDrop(event, null)">
          ${unassignedHtml}
        </div>
      `;
    }

    function populateNPCSelect() {
      const select = document.getElementById('token-npc-select');
      if (!select) return;
      
      const npcs = data.npcs.filter(npc => npc.status !== 'Dead');
      select.innerHTML = '<option value="">Select NPC</option>' +
        npcs.map(npc => `<option value="${npc.id}">${npc.name}</option>`).join('');
    }

    // Import/Export Functions
    function exportData() {
      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `daggerheart-campaign-${Date.now()}.json`;
      link.click();
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          data = JSON.parse(e.target.result);
          saveToStorage();
          location.reload();
        } catch (error) {
          alert('Invalid data file');
        }
      };
      reader.readAsText(file);
    }

    function importPools(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const pools = JSON.parse(e.target.result);
          if (pools.namePool) data.namePool = pools.namePool;
          if (pools.townPool) data.townPool = pools.townPool;
          if (pools.areaPool) data.areaPool = pools.areaPool;
          if (pools.hookPool) data.hookPool = pools.hookPool;
          saveToStorage();
          alert('Pools imported successfully!');
        } catch (error) {
          alert('Invalid pools file');
        }
      };
      reader.readAsText(file);
    }

    // Streamer View Functions
    function openStreamerView() {
      const url = window.location.href.split('?')[0] + '?streamer=true';
      window.open(url, 'StreamerView', 'width=1000,height=800');
    }

    window.addEventListener('storage', (e) => {
      if (e.key === 'daggerheartData') {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('streamer') === 'true') {
          loadFromStorage();
          renderSessionView();
        }
      }
    });

    function checkStreamerView() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('streamer') === 'true') {
        document.body.innerHTML = `
          <div class="streamer-view">
            <div style="max-width: 1600px; margin: 0 auto;">
              <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-bottom: 2rem;">
                <div class="fear-tracker">
                  <h2>Fear</h2>
                  <div style="text-align: center; font-size: 2rem; font-weight: bold; margin-bottom: 1rem; color: #dc2626;">
                    <span id="fear-counter">0</span> / 12
                  </div>
                  <div id="fear-display" class="fear-tokens"></div>
                </div>
                <div class="countdown-section">
                  <h2 style="text-align: center;">Countdowns</h2>
                  <div id="countdowns-list"></div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                <div class="spotlight-section">
                  <h2 style="text-align: center;">Player Spotlight</h2>
                  <div id="spotlight-list" class="spotlight-grid"></div>
                </div>
                <div class="combat-zones-section">
                  <h2 style="text-align: center;">Combat Zones</h2>
                  <div id="combat-zones-container" class="combat-zones-container"></div>
                  <div class="unassigned-tokens" style="margin-top: 1.5rem;">
                    <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; text-align: center;">Unassigned</h3>
                    <div id="unassigned-tokens" class="zone-tokens-container"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        let lastFearAction = null;
        
        setInterval(() => {
          loadFromStorage();
          renderSessionView();
          
          const fearActionStr = localStorage.getItem('fearAction');
          if (fearActionStr) {
            const fearAction = JSON.parse(fearActionStr);
            if (fearAction.type === 'spend' && (!lastFearAction || lastFearAction.timestamp !== fearAction.timestamp)) {
              lastFearAction = fearAction;
              showFearSpendFlash();
            }
          }
        }, 500);
      }
    }
    
    function showFearSpendFlash() {
      const flash = document.createElement('div');
      flash.className = 'fear-spend-flash';
      flash.innerHTML = '<div class="fear-spend-text">GM USES A FEAR!</div>';
      document.body.appendChild(flash);
      
      setTimeout(() => {
        document.body.removeChild(flash);
      }, 1200);
    }

    // Token type selector handler
    document.addEventListener('DOMContentLoaded', () => {
      const typeSelect = document.getElementById('token-type');
      const nameInput = document.getElementById('token-name');
      const npcSelect = document.getElementById('token-npc-select');
      
      if (typeSelect && nameInput && npcSelect) {
        typeSelect.addEventListener('change', (e) => {
          if (e.target.value === 'npc') {
            nameInput.classList.add('hidden');
            npcSelect.classList.remove('hidden');
          } else {
            nameInput.classList.remove('hidden');
            npcSelect.classList.add('hidden');
          }
        });
      }
    });

    // Initialize
    loadFromStorage();
    switchTab('characters');
    checkStreamerView();
    renderPCs();
    renderNPCList();
    filterNPCs();
    renderTownList();
    renderAreaList();
    renderHookList();
    renderLootList();
  </script>
</body>
</html>